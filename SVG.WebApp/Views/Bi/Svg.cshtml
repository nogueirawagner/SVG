@{
    Layout = "_LayoutBi";
    ViewData["Title"] = "BI / Adesão SVG";
}

@Html.Partial("_GraficoSvg")

@section Scripts {
<script>
let chartSvg;

function agruparPorLabel(dados) {

    const mapa = {};

    dados.forEach(d => {

        const label = d.label;

        if (!mapa[label]) {
            mapa[label] = 0;
        }

        mapa[label] += Number(d.total ?? 0);
    });

    return Object.entries(mapa)
        .map(([label, total]) => ({ label, total }));
}


document.addEventListener("bi:changed", async () => {

    const qs = buildPeriodicidadeQuery();
    const resp = await fetch(`/bi/adesao-svg?${qs}`);
    if (!resp.ok) return;

    let dados = await resp.json();
    if (!dados?.length) return;

    if (biState.Periodo === "mensal") {
        dados = agruparPorLabel(dados);
    }

    if (chartSvg) chartSvg.destroy();

    chartSvg = new Chart(
        document.getElementById("graficoSvg"),
        {
            type: "bar",
            data: {
                labels: dados.map(d => d.label),
                datasets: [{
                    label: "SVG",
                    data: dados.map(d => d.total)
                }]
            },
            options: { responsive: true }
        }
    );
});

</script>
}

