@{
    Layout = "_LayoutBi";
    ViewData["Title"] = "BI / Dashboard";
}

<div class="container-fluid">
    <div class="row mt-4">
        <div class="col-12">
            @Html.Partial("_GraficoSvg")
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let chartSvg;

        document.addEventListener("bi:changed", async () => {

            const qs = buildPeriodicidadeQuery();

            const resp = await fetch(`/bi/adesao-svg?${qs}`);
            if (!resp.ok) return;

            const dados = await resp.json();
            if (!dados?.length) return;

            if (chartSvg) chartSvg.destroy();

            chartSvg = new Chart(
                document.getElementById("graficoSvg"),
                {
                    type: "bar",
                    data: {
                        labels: dados.map(d => d.label),
                        datasets: [{
                            label: "SVG",
                            data: dados.map(d => d.total)
                        }]
                    },
                    options: {
                        responsive: true,
                        onClick: (event, elements) => {
                            if (!elements.length) return;

                            const index = elements[0].index;
                            const label = dados[index].label;

                            // 🔥 drill-down conceitual (exemplo)
                            // você pode mapear label → mês depois
                            biState.Periodo = "mensal";
                            biState.Mes = index + 1;

                            biReload();
                        }
                    }
                }
            );
        });
    </script>
}
