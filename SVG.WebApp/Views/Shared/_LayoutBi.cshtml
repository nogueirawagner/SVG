@{
    Layout = "_Layout";
}

@Html.Partial("_BiFiltros")

<main class="container-fluid mt-3">
    @RenderBody()
</main>

@section Scripts {
    @RenderSection("Scripts", required: false)

    <!-- JS GLOBAL DO BI -->
    <script>
        const biState = {
            ano: null,
            periodo: "mensal",
            secaoId: null,
            operadorId: null
        };

          function buildBiQuery() {
            const qs = new URLSearchParams();

            if (biState.ano)        qs.append("ano", biState.ano);
            if (biState.periodo)    qs.append("periodo", biState.periodo);
            if (biState.secaoId)    qs.append("secaoId", biState.secaoId);
            if (biState.operadorId) qs.append("operadorId", biState.operadorId);

            return qs.toString();
        }

        let biTimer = null;

        function biLoadState() {
            const s = sessionStorage.getItem("biState");
            if (s) Object.assign(biState, JSON.parse(s));
        }

        function biSaveState() {
            sessionStorage.setItem("biState", JSON.stringify(biState));
        }

        function biReload() {
            biSaveState();
            document.dispatchEvent(
                new CustomEvent("bi:changed", { detail: biState })
            );
        }

        function biReloadDebounced(delay = 250) {
            clearTimeout(biTimer);
            biTimer = setTimeout(biReload, delay);
        }

        function biLoadState() {
            const s = sessionStorage.getItem("biState");
            if (s) Object.assign(biState, JSON.parse(s));
        }

        document.addEventListener("DOMContentLoaded", () => {
            biLoadState();

            document.querySelectorAll("[data-bi-filter]").forEach(el => {
                el.value = biState[el.dataset.biFilter] ?? "";

                el.addEventListener("change", e => {
                    biState[el.dataset.biFilter] = e.target.value || null;
                    biReloadDebounced(); // 🔥 aqui
                });
            });

            biReload(); // primeira carga
            biCarregarFiltros();
        });

        async function biCarregarFiltros() {
            const resp = await fetch("/bi/filtros");
            const data = await resp.json();

            // ANOS
            const selAno = document.getElementById("biAno");
            data.anos.forEach(a => {
                const opt = document.createElement("option");
                opt.value = a;
                opt.textContent = a;
                selAno.appendChild(opt);
            });

            // OPERADORES
            const selOperador = document.getElementById("biOperador");
            if (selOperador) {
                data.operadores.forEach(o => {
                    const opt = document.createElement("option");
                    opt.value = o.operadorID;
                    opt.textContent = `${o.nome} (${o.sessaoNome})`;
                    selOperador.appendChild(opt);
                });
            }

            // Datas disponíveis (se quiser usar depois)
            console.log("BI Range:", data.dataMin, data.dataMax);
        }

    </script>
}
