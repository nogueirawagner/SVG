@{
    Layout = "_Layout";
}

@Html.Partial("_BiFiltros")

<main class="container-fluid mt-3">
    @RenderBody()
</main>

@section Scripts {
    @RenderSection("Scripts", required: false)

    <script>
        const biState = {
            Periodo: "mensal",
            Ano: null,
            Mes: null,
            SecaoId: null,
            OperadorId: null
        };

        let biTimer = null;

        function biSaveState() {
            sessionStorage.setItem("biState", JSON.stringify(biState));
        }

        function biLoadState() {
            const s = sessionStorage.getItem("biState");
            if (s) Object.assign(biState, JSON.parse(s));
        }

        function buildPeriodicidadeQuery() {
            const qs = new URLSearchParams();

            if (biState.Periodo)    qs.append("Periodo", biState.Periodo);
            if (biState.Ano)        qs.append("Ano", biState.Ano);
            if (biState.Mes)        qs.append("Mes", biState.Mes);
            if (biState.SecaoId)    qs.append("SecaoId", biState.SecaoId);
            if (biState.OperadorId) qs.append("OperadorId", biState.OperadorId);

            return qs.toString();
        }

        function biReload() {
            biSaveState();
            document.dispatchEvent(new CustomEvent("bi:changed", { detail: biState }));
        }

        function biReloadDebounced(delay = 250) {
            clearTimeout(biTimer);
            biTimer = setTimeout(biReload, delay);
        }

        async function biCarregarFiltros() {
            try {
                console.log("🔎 Carregando filtros BI…");

                const resp = await fetch("/bi/filtros", { cache: "no-store" });
                console.log("🌐 /bi/filtros status:", resp.status);

                if (!resp.ok) {
                    const text = await resp.text();
                    console.error("❌ Erro ao buscar filtros:", text);
                    return;
                }

                const data = await resp.json();
                console.log("✅ Filtros recebidos:", data);

                // ===== ANO =====
                const selAno = document.getElementById("biAno");
                if (selAno) {
                    // limpa opções exceto "Todos"
                    selAno.querySelectorAll("option:not([value=''])").forEach(o => o.remove());

                    const anos = (data.anos ?? []).map(Number).filter(a => !Number.isNaN(a));
                    console.log("📅 anos:", anos);

                    anos.forEach(a => {
                        const opt = document.createElement("option");
                        opt.value = String(a);
                        opt.textContent = String(a);
                        selAno.appendChild(opt);
                    });

                    // default: maior ano se ainda não tiver setado (null, "", "null", "undefined")
                    const anoAtual = biState.Ano;
                    const naoTemAno = !anoAtual || anoAtual === "null" || anoAtual === "undefined";

                    if (naoTemAno && anos.length) {
                        const maiorAno = Math.max(...anos);
                        biState.Ano = String(maiorAno);
                        selAno.value = biState.Ano;
                        biSaveState();
                        console.log("⭐ Ano default definido:", biState.Ano);
                    } else {
                        // tenta aplicar o que já está no state
                        selAno.value = biState.Ano ?? "";
                    }
                }

                // (se você também tiver seção/operador, preencha aqui do mesmo jeito)

            } catch (err) {
                console.error("💥 Falha em biCarregarFiltros:", err);
            }
        }


        document.addEventListener("DOMContentLoaded", async () => {
            biLoadState();
            await biCarregarFiltros();

            document.querySelectorAll("[data-bi-filter]").forEach(el => {
                el.value = biState[el.dataset.biFilter] ?? "";

                el.addEventListener("change", e => {
                    biState[el.dataset.biFilter] = e.target.value || null;
                    biReloadDebounced();
                });
            });

            biReload();
        });

      const selAno = document.getElementById("biAno");
        if (selAno && data.anos?.length) {
            // popula
            data.anos.forEach(a => {
                const opt = document.createElement("option");
                opt.value = a;
                opt.textContent = a;
                selAno.appendChild(opt);
            });

            // 🔥 default: maior ano (se ainda não tiver nada salvo)
            if (!biState.Ano) {
                const maiorAno = Math.max(...data.anos.map(Number));
                biState.Ano = String(maiorAno);
                selAno.value = biState.Ano;
                biSaveState();
            }
        }

    </script>
}
