@using SVG.Domain.TiposEstruturados.TiposOperacao
@model IEnumerable<DetalhesOperacao>

@{
    ViewData["Title"] = "Detalhes da Operação";

    // Pega o primeiro item da lista para exibir o cabeçalho da operação
    var op = Model.FirstOrDefault();
}

<div class="container mt-4">

    <h2 class="mb-3">Detalhes da Operação</h2>
    <hr />

    @if (op == null)
    {
        <div class="alert alert-warning">Nenhum registro encontrado.</div>
        <div class="mt-4">
            <a href="@Url.Action("Index", "Operacao")"
               class="btn btn-sm btn-outline-secondary me-1">
                Voltar
            </a>
        </div>
        return;
    }

    <!-- =======================
         DADOS GERAIS DA OPERAÇÃO
         ======================= -->
    <div class="card mb-4">
        <div class="card-header fw-bold">
            Informações da Operação
        </div>
        <div class="card-body">

            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="fw-bold">Criada em:</label>
                    <div>@op.DataHoraCriacao.ToString("dd/MM/yyyy HH:mm")</div>
                </div>

                <div class="col-md-3">
                    <label class="fw-bold">Data da Operação:</label>
                    <div>@op.DataHora.ToString("dd/MM/yyyy HH:mm")</div>
                </div>

                <div class="col-md-3">
                    <label class="fw-bold">Coordenador:</label>
                    <div>@op.Coordenador</div>
                </div>

                <div class="col-md-3">
                    <label class="fw-bold">Tipo de Operação:</label>
                    <div>@op.TipoOperacao</div>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="fw-bold">Objeto:</label>
                    <div>@op.Objeto</div>
                </div>
            </div>

        </div>
    </div>

    <!-- =======================
         TABELA DE OPERADORES
         ======================= -->
    @{
        var total = Model.Count();
        var voluntarios = Model.Count(x => x.SVG); // SVG = true
        var ordinarios = total - voluntarios;      // SVG = false
    }

    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <h4 class="mb-0">Operadores da Operação</h4>

        <div class="d-flex align-items-center gap-2">
            <span class="badge bg-secondary">Total <span id="cntTotal">@total</span></span>
            <span class="badge bg-dark">Ordinário <span id="cntOrdinario">@ordinarios</span></span>
            <span class="badge bg-success">Voluntário <span id="cntVoluntario">@voluntarios</span></span>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-striped" id="tabelaOperadores">
            <thead class="table-light">
                <tr>
                    <th style="width:60px;" class="text-center">#</th>
                    <th>Nome</th>
                    <th>Matrícula</th>
                    <th>Sessão</th>
                    <th class="text-center">SVG</th>
                </tr>
            </thead>

            <tbody>
                @{
                    var i = 1;
                }
                @foreach (var item in Model)
                {
                    <tr data-operador-id="@item.OperadorID">
                        <td class="text-center fw-semibold">@i</td>
                        <td>@item.NomeOperador</td>
                        <td>@item.Matricula</td>
                        <td>@item.Sessao</td>

                        <td class="text-center">
                            <button type="button"
                                    class="btn btn-sm toggle-svg-btn @(item.SVG ? "btn-success" : "btn-danger")"
                                    data-svg="@item.SVG.ToString().ToLower()">
                                @(item.SVG ? "Sim" : "Não")
                            </button>
                        </td>
                    </tr>
                    i++;

                }
            </tbody>
        </table>
    </div>

    <div class="mt-4">
        <a href="@Url.Action("Index", "Operacao")"
           class="btn btn-sm btn-outline-secondary me-1">
            Voltar
        </a>
        <a href="@Url.Action("Delete", "Operacao", new { id = op.ID })"
           class="btn btn-sm btn-outline-danger">
            Excluir
        </a>
    </div>





</div>


@section Scripts {
    <script>
                document.addEventListener("DOMContentLoaded", function () {

                    const urlAlterar = '@Url.Action("AlterarSVGOperador", "Operacao")';


                    function atualizarContadores() {
                        const linhas = document.querySelectorAll("#tabelaOperadores tbody tr");
                        const total = linhas.length;

                        let voluntario = 0;
                        linhas.forEach(tr => {
                            const btn = tr.querySelector(".toggle-svg-btn");
                            const isSvg = btn && btn.getAttribute("data-svg") === "true";
                            if (isSvg) voluntario++;
                        });

                        const ordinario = total - voluntario;

                        const elTotal = document.getElementById("cntTotal");
                        const elOrdinario = document.getElementById("cntOrdinario");
                        const elVoluntario = document.getElementById("cntVoluntario");

                        if (elTotal) elTotal.textContent = total;
                        if (elOrdinario) elOrdinario.textContent = ordinario;
                        if (elVoluntario) elVoluntario.textContent = voluntario;
                    }
        // evento para todos os botões ON/OFF
                    document.querySelectorAll(".toggle-svg-btn").forEach(btn => {

                        btn.addEventListener("click", async function () {

                            const tr = this.closest("tr");
                            const operadorId = tr.getAttribute("data-operador-id");

                            let estadoAtual = this.getAttribute("data-svg") === "true";
                            let novoEstado = !estadoAtual;

                            // chama o serviço no controller
                            try {
                                const resp = await fetch(`${urlAlterar}?pOperadorID=${operadorId}&pSVG=${novoEstado}`, {
                                    method: "POST"
                                });

                                if (!resp.ok) {
                                    alert("Erro ao alterar SVG");
                                    return;
                                }

                                // atualiza visualmente
                                this.setAttribute("data-svg", novoEstado.toString());

                                if (novoEstado) {
                                    this.classList.remove("btn-danger");
                                    this.classList.add("btn-success");
                                    this.textContent = "Sim";
                                } else {
                                    this.classList.remove("btn-success");
                                    this.classList.add("btn-danger");
                                    this.textContent = "Não";
                                }


                                atualizarContadores();

                            }
                        } catch (e) {
                                console.error(e);
                                alert("Falha ao conectar com o servidor.");
                            }
                        });
                    });

                    atualizarContadores();


                });
    </script>
}
