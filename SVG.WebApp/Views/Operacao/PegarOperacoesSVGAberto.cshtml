@using SVG.Domain.TiposEstruturados.TiposOperacao
@model IEnumerable<OperacoesSVGAberto>

@{
    ViewData["Title"] = "Operações com SVG Aberto";

    // Operadores (para selects e filtros client-side)
    var operadoresJson = (string)ViewBag.OperadoresJson ?? "[]";

    // Grupos já montados no Controller (ViewBag.GruposTipoOperacao)
    // Esperado: coleção de objetos com { TipoOperacao, Operacoes (List<OperacoesSVGAberto>) }
    var gruposDyn = ViewBag.GruposTipoOperacao as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var grupos = gruposDyn.ToList();

    // Sessões vindo do Controller (ViewBag.Sessoes)
    // Usando dynamic para não depender de namespace do tipo Sessao
    var sessoesDyn = ViewBag.Sessoes as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
    var sessoes = sessoesDyn.ToList();

    // Total operações (se quiser mostrar no topo)
    int totalOps = 0;
    try { totalOps = (Model ?? Enumerable.Empty<OperacoesSVGAberto>()).Count(); } catch { totalOps = 0; }
}

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center">
        <h2 class="mb-0">Operações com SVG Aberto</h2>
        <span class="badge bg-primary">Total: @totalOps</span>
    </div>

    <hr />

    @* Anti-forgery token para POST via fetch (se o projeto estiver com ValidateAntiForgeryToken ligado) *@
    <form id="antiForgeryForm" style="display:none;">
        @Html.AntiForgeryToken()
    </form>

    <div class="row mt-3 g-3 align-items-start">

        <!-- =======================
             COLUNA ESQUERDA: OPERAÇÕES
             ======================= -->
        <div class="col-12 col-lg-4">
            <div class="card h-100">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <span>Operações (SVG aberto)</span>
                    <span class="badge bg-success">@totalOps</span>
                </div>

                <div class="card-body p-2">

                    <div class="mb-2">
                        <input type="text" id="operacaoSearch" class="form-control form-control-sm"
                               placeholder="Buscar (tipo, id, data, vagas)..." />
                    </div>

                    @if (totalOps == 0 || grupos.Count == 0)
                    {
                        <div class="alert alert-info mb-0">
                            Nenhuma operação com SVG aberto.
                        </div>
                    }
                    else
                    {
                        <div id="operacoesContainer">
                            @for (int i = 0; i < grupos.Count; i++)
                            {
                                var g = grupos[i];
                                var collapseId = $"collapseTipo_{i}";

                                <div class="mb-2 operacao-grupo">

                                    <!-- Cabeçalho do grupo (colapsável, fechado por padrão) -->
                                    <button class="btn btn-light w-100 d-flex justify-content-between align-items-center"
                                            type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#@collapseId"
                                            aria-expanded="false"
                                            aria-controls="@collapseId">
                                        <span class="fw-semibold">@g.TipoOperacao</span>
                                        <span class="badge bg-secondary">@g.Operacoes.Count</span>
                                    </button>

                                    <!-- Conteúdo -->
                                    <div class="collapse mt-1" id="@collapseId">
                                        <ul class="list-group">
                                            @foreach (var op in g.Operacoes)
                                            {
                                                var textoFiltro = $"{g.TipoOperacao} {op.ID} {op.DataHora:dd/MM/yyyy HH:mm} {op.QtdVagasRestantes}".ToLower();

                                                <li class="list-group-item list-group-item-action py-2 operacao-item"
                                                    style="cursor:pointer;"
                                                    data-id="@op.ID"
                                                    data-filtro="@textoFiltro">

                                                    <div class="d-flex justify-content-between">
                                                        <div class="me-2">
                                                            <div class="fw-semibold">@g.TipoOperacao</div>
                                                            <div class="text-muted small">
                                                                <span class="me-2">ID: <strong>@op.ID</strong></span>
                                                                <span>Criada: <strong>@op.DataHoraCriacao.ToString("dd/MM HH:mm")</strong></span>
                                                            </div>
                                                        </div>

                                                        <div class="text-end">
                                                            <div class="small fw-semibold">@op.DataHora.ToString("dd/MM HH:mm")</div>
                                                            <span class="badge bg-warning text-dark">Vagas: @op.QtdVagasRestantes</span>
                                                        </div>
                                                    </div>

                                                     @{
                                                        // dynamic-safe: tenta tratar DataHoraFim como nullable e como não-null
                                                        string fimFormatado = null;

                                                        try
                                                        {
                                                            // se for DateTime?
                                                            DateTime? fimN = (DateTime?)op.DataHoraFim;
                                                            if (fimN.HasValue)
                                                                fimFormatado = fimN.Value.ToString("dd/MM HH:mm");
                                                        }
                                                        catch
                                                        {
                                                            // se for DateTime
                                                            try
                                                            {
                                                                DateTime fim = (DateTime)op.DataHoraFim;
                                                                // se quiser, pode ignorar default(DateTime) = 01/01/0001
                                                                if (fim != default(DateTime))
                                                                    fimFormatado = fim.ToString("dd/MM HH:mm");
                                                            }
                                                            catch { }
                                                        }
                                                    }

                                                    @if (!string.IsNullOrEmpty(fimFormatado))
                                                    {
                                                        <div class="text-muted small mt-1">
                                                            Início: <strong>@op.DataHoraInicio.ToString("dd/MM HH:mm")</strong>
                                                        </div>
                                                        <div class="text-muted small mt-1">
                                                            Fim: <strong>@fimFormatado</strong>
                                                        </div>
                                                    }
                                                </li>
                                            }
                                        </ul>
                                    </div>

                                </div>
                            }
                        </div>
                    }

                </div>
            </div>
        </div>

        <!-- =======================
             COLUNA MEIO: CANDIDATOS AO SVG (selecionados)
             ======================= -->
        <div class="col-12 col-lg-5">
            <div class="card h-100">
                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                    <span>Candidatos ao Voluntário para Operação</span>
                    <span id="badgeOperacaoSelecionada" class="badge bg-dark">Nenhuma operação selecionada</span>
                </div>

                <div class="card-body p-3">

                    <input type="hidden" id="operacaoIdSelecionada" value="" />

                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label mb-1">Buscar Operador</label>

                            <input type="text"
                                   id="operadorSearch"
                                   class="form-control mb-2"
                                   placeholder="Digite o nome para filtrar..."
                                   disabled />

                            <div class="d-flex gap-2">
                                <select id="operadorSelect" class="form-select form-select-sm flex-grow-1" disabled>
                                    <option value="">Selecione um operador...</option>
                                </select>

                                <button type="button"
                                        id="btnAddOperador"
                                        class="btn btn-primary btn-sm align-self-center"
                                        style="white-space: nowrap;"
                                        disabled>
                                    Adicionar
                                </button>
                            </div>
                        </div>
                    </div>

                    <hr class="my-3" />

                    <div class="mb-2 d-flex align-items-center flex-wrap gap-2">
                        <strong>Operadores selecionados:</strong>
                        <span id="contadorOperadores" class="badge bg-primary">0</span>
                    </div>

                    <ul id="listaOperadoresSelecionados" class="list-group">
                        @* itens via JS *@
                    </ul>

                </div>
            </div>
        </div>

        <!-- =======================
             COLUNA DIREITA: SESSÃO -> OPERADORES
             ======================= -->
        <div class="col-12 col-lg-3">
            <div class="card h-100">
                <div class="card-header py-2">
                    Sessão
                </div>

                <div class="card-body p-2">

                    <label class="form-label mb-1">Selecionar Sessão</label>
                    <div class="d-flex gap-2 mb-2">
                        <select id="sessaoSelect" class="form-select form-select-sm" disabled>
                            <option value="">Selecionar Sessão</option>
                            @* Ordena por Nome para UX; se quiser manter ordem do serviço, remova o OrderBy *@
                            @foreach (var s in sessoes.OrderBy(x => (string)x.Nome))
                            {
                                <option value="@s.ID">@s.Nome</option>
                            }
                        </select>
                    </div>

                    <div class="fw-semibold small mb-2">Operadores da sessão selecionada:</div>

                    <div id="listaOperadoresSessao" class="border rounded p-1" style="max-height: 420px; overflow:auto;">
                        <div class="text-muted small p-2">
                            Selecione uma operação e uma sessão.
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>

@section Scripts {
<script>
    // ===== Dados do controller
    const operadoresData = @Html.Raw(operadoresJson);

    // ===== Elementos
    const operacaoSearch = document.getElementById('operacaoSearch');

    const badgeOperacaoSelecionada = document.getElementById('badgeOperacaoSelecionada');
    const operacaoIdSelecionada = document.getElementById('operacaoIdSelecionada');

    const operadorSearch = document.getElementById('operadorSearch');
    const operadorSelect = document.getElementById('operadorSelect');
    const btnAddOperador = document.getElementById('btnAddOperador');

    const contadorOperadores = document.getElementById('contadorOperadores');
    const listaSelecionados = document.getElementById('listaOperadoresSelecionados');

    const sessaoSelect = document.getElementById('sessaoSelect');
    const listaOperadoresSessao = document.getElementById('listaOperadoresSessao');

    // ===== Endpoints
    const URL_INSERE = '@Url.Action("InsereCandidatoSVG", "Operacao")';
    const URL_REMOVE = '@Url.Action("RemoveCandidatoSVG", "Operacao")';

    // ===== Anti-forgery
    function getAntiForgeryToken() {
        const el = document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]');
        return el ? el.value : null;
    }

    async function postForm(url, dataObj) {
        const token = getAntiForgeryToken();
        const form = new URLSearchParams();

        Object.keys(dataObj || {}).forEach(k => form.append(k, dataObj[k]));

        // envia token se existir
        if (token) form.append('__RequestVerificationToken', token);

        const resp = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
            body: form.toString()
        });

        return resp;
    }

    async function insereCandidatoSvg(operacaoId, operadorId) {
        try {
            const resp = await postForm(URL_INSERE, { pOperacaoID: operacaoId, pOperadorID: operadorId });
            return resp.ok;
        } catch (e) {
            console.error(e);
            return false;
        }
    }

    async function removeCandidatoSvg(operacaoId, operadorId) {
        try {
            const resp = await postForm(URL_REMOVE, { pOperacaoID: operacaoId, pOperadorID: operadorId });
            return resp.ok;
        } catch (e) {
            console.error(e);
            return false;
        }
    }

    // ===== UI helpers
    function habilitarPainelDireito(habilitar) {
        operadorSearch.disabled = !habilitar;
        operadorSelect.disabled = !habilitar;
        btnAddOperador.disabled = !habilitar;

        sessaoSelect.disabled = !habilitar;

        if (!habilitar) {
            listaOperadoresSessao.innerHTML = `<div class="text-muted small p-2">Selecione uma operação e uma sessão.</div>`;
        }
    }

    function atualizarContadorOperadores() {
        contadorOperadores.textContent = listaSelecionados.children.length;
    }

    function renumerarSelecionados() {
        const itens = Array.from(listaSelecionados.children);
        const total = itens.length;

        itens.forEach((li, idx) => {
            const badgeNum = li.querySelector('.badgeNumero');
            if (badgeNum) badgeNum.textContent = (total - idx);
        });

        atualizarContadorOperadores();
    }

    function criarItemOperador({ operadorId, nome, matricula }) {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.dataset.operadorId = operadorId;

        li.innerHTML = `
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-secondary badgeNumero">0</span>
                <div>
                    <div class="fw-semibold">${nome}</div>
                    <div class="text-muted small">${matricula}</div>
                </div>
            </div>

            <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn btn-outline-danger btn-sm btnRemover">
                    Remover
                </button>

                <input type="hidden" class="inputOperadorId" value="${operadorId}">
            </div>
        `;

        li.querySelector('.btnRemover').addEventListener('click', async function () {
            const operacaoId = parseInt(operacaoIdSelecionada.value || '0');
            const opId = parseInt(operadorId || '0');
            if (!operacaoId || !opId) return;

            const ok = await removeCandidatoSvg(operacaoId, opId);
            if (!ok) return;

            li.remove();
            renumerarSelecionados();
        });

        return li;
    }

    function preencherComboOperadores() {
        operadorSelect.querySelectorAll('option:not(:first-child)').forEach(o => o.remove());

        operadoresData
            .slice()
            .sort((a, b) => (a.Nome || '').localeCompare(b.Nome || ''))
            .forEach(op => {
                const opt = document.createElement('option');
                opt.value = op.ID;
                opt.text = `${op.Nome} (${op.Matricula})`;
                operadorSelect.appendChild(opt);
            });
    }

    // ===== Operações (seleção)
    document.querySelectorAll('.operacao-item').forEach(li => {
        li.addEventListener('click', function () {

            // marca seleção visual
            document.querySelectorAll('.operacao-item.active').forEach(x => x.classList.remove('active'));
            this.classList.add('active');

            const id = this.dataset.id;
            operacaoIdSelecionada.value = id;

            badgeOperacaoSelecionada.textContent = `Operação #${id}`;
            habilitarPainelDireito(true);

            // não limpamos automaticamente a lista selecionada aqui
            // (pode ser que você queira manter o que já selecionou)
            // se quiser limpar ao trocar de operação, descomente:
            // listaSelecionados.innerHTML = ''; renumerarSelecionados();
        });
    });

    // ===== Filtro de operações (texto)
    operacaoSearch?.addEventListener('input', function () {
        const termo = (this.value || '').trim().toLowerCase();
        document.querySelectorAll('.operacao-item').forEach(item => {
            const texto = (item.dataset.filtro || '');
            item.style.display = (!termo || texto.includes(termo)) ? '' : 'none';
        });
    });

    // ===== Busca de operador: filtra SELECT e lista da sessão
    operadorSearch?.addEventListener('input', function () {
        const termo = (this.value || '').trim().toLowerCase();

        // filtra options do select
        Array.from(operadorSelect.options).forEach((opt, idx) => {
            if (idx === 0) return;
            opt.hidden = termo && !(opt.text || '').toLowerCase().includes(termo);
        });

        if (operadorSelect.selectedOptions.length && operadorSelect.selectedOptions[0].hidden) {
            operadorSelect.selectedIndex = 0;
        }

        // filtra lista de sessão (se já estiver renderizada)
        Array.from(listaOperadoresSessao.querySelectorAll('[data-op-row="1"]')).forEach(row => {
            const txt = (row.dataset.filtro || '');
            row.style.display = (!termo || txt.includes(termo)) ? '' : 'none';
        });
    });

    // ===== Adicionar via SELECT
    btnAddOperador?.addEventListener('click', async function () {
        const operacaoId = parseInt(operacaoIdSelecionada.value || '0');
        if (!operacaoId) return;

        const opId = parseInt(operadorSelect.value || '0');
        if (!opId) return;

        // evita duplicar
        if (listaSelecionados.querySelector(`li[data-operador-id="${opId}"]`)) return;

        const op = operadoresData.find(x => parseInt(x.ID) === opId);
        if (!op) return;

        const ok = await insereCandidatoSvg(operacaoId, opId);
        if (!ok) return;

        const item = criarItemOperador({
            operadorId: op.ID,
            nome: op.Nome,
            matricula: op.Matricula
        });

        listaSelecionados.prepend(item);
        renumerarSelecionados();

        operadorSelect.selectedIndex = 0;
    });

    // ===== Sessão -> listar operadores com botão Adicionar
    function renderOperadoresDaSessao(sessaoId) {
        listaOperadoresSessao.innerHTML = '';

        const operacaoId = parseInt(operacaoIdSelecionada.value || '0');
        if (!operacaoId) {
            listaOperadoresSessao.innerHTML = `<div class="text-muted small p-2">Selecione uma operação primeiro.</div>`;
            return;
        }

        if (!sessaoId) {
            listaOperadoresSessao.innerHTML = `<div class="text-muted small p-2">Selecione uma sessão.</div>`;
            return;
        }

        const ops = operadoresData
            .filter(o => String(o.SessaoID) === String(sessaoId))
            .sort((a, b) => (a.Nome || '').localeCompare(b.Nome || ''));

        if (!ops.length) {
            listaOperadoresSessao.innerHTML = `<div class="text-muted small p-2">Nenhum operador nesta sessão.</div>`;
            return;
        }

        ops.forEach(o => {
            const row = document.createElement('div');
            row.className = 'd-flex justify-content-between align-items-center border-bottom px-2 py-2';
            row.dataset.opRow = "1";
            row.dataset.filtro = `${(o.Nome || '')} ${(o.Matricula || '')}`.toLowerCase();

            // já está na lista?
            const jaExiste = !!listaSelecionados.querySelector(`li[data-operador-id="${o.ID}"]`);

            row.innerHTML = `
                <div class="me-2">
                    <div class="small fw-semibold">${o.Nome}</div>
                    <div class="text-muted small">${o.Matricula}</div>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" ${jaExiste ? 'disabled' : ''}>
                    Adicionar
                </button>
            `;

            const btn = row.querySelector('button');
            btn.addEventListener('click', async () => {
                const operacaoId = parseInt(operacaoIdSelecionada.value || '0');
                const opId = parseInt(o.ID || '0');
                if (!operacaoId || !opId) return;

                if (listaSelecionados.querySelector(`li[data-operador-id="${opId}"]`)) {
                    btn.disabled = true;
                    return;
                }

                const ok = await insereCandidatoSvg(operacaoId, opId);
                if (!ok) return;

                const item = criarItemOperador({
                    operadorId: o.ID,
                    nome: o.Nome,
                    matricula: o.Matricula
                });

                listaSelecionados.prepend(item);
                renumerarSelecionados();

                btn.disabled = true;
            });

            listaOperadoresSessao.appendChild(row);
        });

        // reaplica filtro atual (se houver)
        const termo = (operadorSearch.value || '').trim().toLowerCase();
        if (termo) {
            Array.from(listaOperadoresSessao.querySelectorAll('[data-op-row="1"]')).forEach(row => {
                const txt = (row.dataset.filtro || '');
                row.style.display = txt.includes(termo) ? '' : 'none';
            });
        }
    }

    sessaoSelect?.addEventListener('change', function () {
        renderOperadoresDaSessao(this.value);
    });

    // ===== Init
    preencherComboOperadores();
    habilitarPainelDireito(false);
    atualizarContadorOperadores();
</script>
}
