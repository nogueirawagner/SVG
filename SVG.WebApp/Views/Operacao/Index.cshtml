@model IEnumerable<SVG.Domain.TiposEstruturados.TiposOperacao.OperacoesRealizadas>

@{
    ViewData["Title"] = "Operações";

    var anos = Model?
        .Select(m => m.DataHoraCriacao.Year)
        .Distinct()
        .OrderByDescending(a => a)
        .ToList() ?? new List<int>();

    var total = Model?.Count() ?? 0;
    var contador = Model?.Count() ?? 0;
}

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Operações</h2>
        <a href="@Url.Action("Create", "Operacao")"
           class="btn btn-primary">
            Nova Operação
        </a>
    </div>

    <!-- FILTROS -->
    <div class="row g-2 mb-2">
        <div class="col-md-3">
            <input type="text"
                   id="filtroOperacoes"
                   class="form-control"
                   placeholder="Buscar por local, coordenador, tipo ou OS..." />
        </div>

        <!-- NOVO: Tipo de Operação -->
        <div class="col-md-1 col-lg-1">
            <select id="filtroTipoOperacao" class="form-select">
                <option value="">Tipo</option>
                <option value="Apoio">Apoio</option>
                <option value="Alvorada">Alvorada</option>
                <option value="Delta">Delta</option>
                <option value="Segurança Orgânica">Segurança Orgânica</option>
                <option value="Reforço Plantão">Reforço Plantão</option>
            </select>
        </div>

        <div class="col-md-1">
            <select id="filtroMes" class="form-select">
                <option value="">Mês</option>
                <option value="1">Janeiro</option>
                <option value="2">Fevereiro</option>
                <option value="3">Março</option>
                <option value="4">Abril</option>
                <option value="5">Maio</option>
                <option value="6">Junho</option>
                <option value="7">Julho</option>
                <option value="8">Agosto</option>
                <option value="9">Setembro</option>
                <option value="10">Outubro</option>
                <option value="11">Novembro</option>
                <option value="12">Dezembro</option>
            </select>
        </div>

        <div class="col-md-1">
            <select id="filtroAno" class="form-select">
                <option value="">Ano</option>
                @foreach (var ano in anos)
                {
                    <option value="@ano">@ano</option>
                }
            </select>
        </div>

        <!-- NOVO: SVG Aberto -->
        <div class="col-md-1 col-lg-1">
            <select id="filtroSvgAberto" class="form-select">
                <option value="">SVG</option>
                <option value="1">Sim</option>
                <option value="0">Não</option>
            </select>
        </div>

        <button type="button"
                id="btnLimparFiltrosTopo"
                class="btn btn-sm btn-outline-secondary col-md-1 col-lg-1">
            Limpar filtros
        </button>

    </div>

    <!-- CONTADOR -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <small class="text-muted">
            Exibindo <strong><span id="contadorExibidas">@total</span></strong>
            de <strong><span id="contadorTotal">@total</span></strong> operações
        </small>
    </div>

    @if (Model != null && Model.Any())
    {
        <div class="table-responsive" id="containerTabela">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th class="text-center" style="width:60px;">#</th>
                        <th>OS</th>
                        <th>Criação</th>
                        <th>Horário</th>
                        <th>Local</th>
                        <th>Tipo</th>
                        <th>Coordenador</th>
                        <th class="text-center" style="width: 180px;">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr class="@(item.SvgAberto ? "table-primary" : "")"
                            data-text="@($"{item.Objeto} {item.Coordenador} {item.TipoOperacao} {item.OrdemServico}".ToLower())"
                            data-mes="@item.DataHoraCriacao.Month"
                            data-ano="@item.DataHoraCriacao.Year"
                            data-svgaberto="@(item.SvgAberto ? "1" : "0")"
                            data-tipo="@((item.TipoOperacao ?? "").ToLower())">
                            
                            <td class="text-center fw-semibold">
                                @contador
                            </td>
                            <td>@item.OrdemServico</td>
                            <td>@item.DataHoraCriacao.ToString("dd/MM HH:mm")</td>
                            <td>
                                @item.DataHora.ToString("dd/MM HH:mm")
                                @if (item.DataHoraFim.HasValue)
                                {
                                    <span> às @item.DataHoraFim.Value.ToString("dd/MM HH:mm")</span>
                                }
                            </td>
                            <td>@item.Objeto</td>
                            <td>@item.TipoOperacao</td>
                            <td>@item.Coordenador</td>
                            <td class="text-center">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                            type="button"
                                            data-bs-toggle="dropdown"
                                            aria-expanded="false">
                                        Ações
                                    </button>

                                    <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                            @if (item.SvgAberto)
                                            {
                                                <a class="dropdown-item text-success fw-semibold"
                                                   href="#"
                                                   data-bs-toggle="modal"
                                                   data-bs-target="#encerrarSvgModal"
                                                   data-id="@item.ID">
                                                    Encerrar SVG: @item.QtdVagasRestantes vagas
                                                </a>
                                            }
                                            else
                                            {
                                                <span class="dropdown-item disabled text-muted">
                                                    Encerrado SVG
                                                </span>
                                            }
                                        </li>
                                        <li>
                                            <a class="dropdown-item"
                                               href="@Url.Action("DetalhesOperacao", "Operacao", new { pOperacaoID = item.ID })">
                                                Detalhes
                                            </a>
                                        </li>

                                        <li>
                                            <a class="dropdown-item"
                                               href="@Url.Action("Edit", "Operacao", new { id = item.ID })">
                                                Editar
                                            </a>
                                        </li>

                                        <li>
                                            <a class="dropdown-item"
                                               href="@Url.Action("Index", "Operacao", new { id = item.ID })">
                                                Escala
                                            </a>
                                        </li>

                                        <li><hr class="dropdown-divider"></li>

                                        <li>
                                            <a class="dropdown-item text-danger"
                                               href="@Url.Action("Delete", "Operacao", new { id = item.ID })"
                                               onclick="return confirm('Tem certeza que deseja excluir esta operação?');">
                                                Excluir
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </td>
                        </tr>
                        contador--;
                    }
                </tbody>
            </table>
        </div>

        <!-- ESTADO VAZIO (CLIENT-SIDE) -->
        <div id="estadoVazio"
             class="alert alert-info text-center py-4"
             style="display:none;">
            <h5 class="mb-2">Nenhuma operação encontrada</h5>
            <p class="mb-3 text-muted">
                Tente ajustar ou limpar os filtros aplicados.
            </p>

            <button type="button"
                    id="btnLimparFiltros"
                    class="btn btn-outline-primary">
                Limpar filtros
            </button>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center py-4">
            <h5 class="mb-2">Nenhuma operação encontrada</h5>
            <p class="mb-3 text-muted">
                Não há operações cadastradas no momento.
            </p>

            <a href="@Url.Action("Create", "Operacao")"
               class="btn btn-outline-primary">
                Criar nova operação
            </a>
        </div>
    }
</div>

<div class="modal fade" id="encerrarSvgModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Encerrar SVG</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form id="formEncerrarSvg"
                  method="post"
                  action="@Url.Action("EncerrarSVG", "Operacao")">

                @Html.AntiForgeryToken()

                <div class="modal-body">
                    Tem certeza que deseja encerrar o SVG desta operação?
                    <input type="hidden" id="pOperacaoID" name="pOperacaoID" value="" />
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Encerrar SVG</button>
                </div>

            </form>

        </div>
    </div>
</div>



@section Scripts {
    <script>
        const filtroTexto = document.getElementById('filtroOperacoes');
        const filtroMes = document.getElementById('filtroMes');
        const filtroAno = document.getElementById('filtroAno');
        const filtroSvgAberto = document.getElementById('filtroSvgAberto');
        const filtroTipoOperacao = document.getElementById('filtroTipoOperacao'); // NOVO

        const contadorExibidas = document.getElementById('contadorExibidas');
        const contadorTotal = document.getElementById('contadorTotal');

        const btnLimparTopo = document.getElementById('btnLimparFiltrosTopo');
        const btnLimpar = document.getElementById('btnLimparFiltros');

        const linhas = Array.from(document.querySelectorAll('tbody tr'));
        const containerTabela = document.getElementById('containerTabela');
        const estadoVazio = document.getElementById('estadoVazio');

        // Total geral (sempre o total do carregamento inicial da tela)
        if (contadorTotal) contadorTotal.textContent = linhas.length.toString();

        function aplicarFiltros() {
            const texto = (filtroTexto?.value || '').toLowerCase();
            const mes = filtroMes?.value || '';
            const ano = filtroAno?.value || '';
            const svg = filtroSvgAberto?.value || '';
            const tipo = (filtroTipoOperacao?.value || '').toLowerCase(); // NOVO

            let exibidas = 0;

            linhas.forEach(tr => {
                const textoLinha = (tr.dataset.text || '');
                const mesLinha = (tr.dataset.mes || '');
                const anoLinha = (tr.dataset.ano || '');
                const svgLinha = (tr.dataset.svgaberto || '');
                const tipoLinha = (tr.dataset.tipo || ''); // NOVO (já vem em lower-case)

                const matchTexto = textoLinha.includes(texto);
                const matchMes = !mes || mes === mesLinha;
                const matchAno = !ano || ano === anoLinha;
                const matchSvg = !svg || svg === svgLinha;
                const matchTipo = !tipo || tipoLinha === tipo; // NOVO

                const mostrar = matchTexto && matchMes && matchAno && matchSvg && matchTipo;

                tr.style.display = mostrar ? '' : 'none';
                if (mostrar) exibidas++;
            });

            if (contadorExibidas) contadorExibidas.textContent = exibidas.toString();

            if (exibidas === 0) {
                if (containerTabela) containerTabela.style.display = 'none';
                if (estadoVazio) estadoVazio.style.display = 'block';
            } else {
                if (containerTabela) containerTabela.style.display = 'block';
                if (estadoVazio) estadoVazio.style.display = 'none';
            }
        }

        function limparFiltros() {
            if (filtroTexto) filtroTexto.value = '';
            if (filtroMes) filtroMes.value = '';
            if (filtroAno) filtroAno.value = '';
            if (filtroSvgAberto) filtroSvgAberto.value = '';
            if (filtroTipoOperacao) filtroTipoOperacao.value = ''; // NOVO
            aplicarFiltros();
        }

        if (filtroTexto) filtroTexto.addEventListener('input', aplicarFiltros);
        if (filtroMes) filtroMes.addEventListener('change', aplicarFiltros);
        if (filtroAno) filtroAno.addEventListener('change', aplicarFiltros);
        if (filtroSvgAberto) filtroSvgAberto.addEventListener('change', aplicarFiltros);
        if (filtroTipoOperacao) filtroTipoOperacao.addEventListener('change', aplicarFiltros); // NOVO

        if (btnLimparTopo) btnLimparTopo.addEventListener('click', limparFiltros);
        if (btnLimpar) btnLimpar.addEventListener('click', limparFiltros);

        // inicializa
        aplicarFiltros();

        // Modal Encerrar SVG
        const modalEncerrar = document.getElementById('encerrarSvgModal');
        if (modalEncerrar) {
            modalEncerrar.addEventListener('show.bs.modal', function (event) {
                const trigger = event.relatedTarget;
                if (!trigger) return;

                const id = trigger.getAttribute('data-id');
                const input = document.getElementById('pOperacaoID');
                if (input) input.value = id;
            });
        }
    </script>

}
