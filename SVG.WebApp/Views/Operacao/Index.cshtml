@model IEnumerable<SVG.Domain.TiposEstruturados.TiposOperacao.OperacoesRealizadas>

@{
    ViewData["Title"] = "Operações";

    var anos = Model?
        .Select(m => m.DataHoraCriacao.Year)
        .Distinct()
        .OrderByDescending(a => a)
        .ToList() ?? new List<int>();

    var total = Model?.Count() ?? 0;
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Operações</h2>
        <a href="@Url.Action("Create", "Operacao")"
           class="btn btn-primary">
            Nova Operação
        </a>
    </div>

    <!-- FILTROS -->
    <div class="row g-2 mb-2">
        <div class="col-md-4">
            <input type="text"
                   id="filtroOperacoes"
                   class="form-control"
                   placeholder="Buscar por local, coordenador, tipo ou OS..." />
        </div>

        <div class="col-md-3">
            <select id="filtroMes" class="form-select">
                <option value="">Mês (todos)</option>
                <option value="1">Janeiro</option>
                <option value="2">Fevereiro</option>
                <option value="3">Março</option>
                <option value="4">Abril</option>
                <option value="5">Maio</option>
                <option value="6">Junho</option>
                <option value="7">Julho</option>
                <option value="8">Agosto</option>
                <option value="9">Setembro</option>
                <option value="10">Outubro</option>
                <option value="11">Novembro</option>
                <option value="12">Dezembro</option>
            </select>
        </div>

        <div class="col-md-2">
            <select id="filtroAno" class="form-select">
                <option value="">Ano (todos)</option>
                @foreach (var ano in anos)
                {
                    <option value="@ano">@ano</option>
                }
            </select>
        </div>

        <!-- NOVO: SVG Aberto -->
        <div class="col-md-3 col-lg-2">
            <select id="filtroSvgAberto" class="form-select">
                <option value="">SVG Aberto (todas)</option>
                <option value="1">Sim</option>
                <option value="0">Não</option>
            </select>
        </div> 
    </div>

    <!-- CONTADOR -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <small class="text-muted">
            Exibindo <strong><span id="contadorExibidas">@total</span></strong>
            de <strong><span id="contadorTotal">@total</span></strong> operações
        </small>

        <button type="button"
                id="btnLimparFiltrosTopo"
                class="btn btn-sm btn-outline-secondary">
            Limpar filtros
        </button>
    </div>

    @if (Model != null && Model.Any())
    {
        <div class="table-responsive" id="containerTabela">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Criação</th>
                        <th>Operação</th>
                        <th>Local</th>
                        <th>Tipo</th>
                        <th>OS</th>
                        <th>Coordenador</th>
                        <th>Vagas SVG</th>
                        @* <th>SVG Aberto</th> *@
                        <th class="text-center" style="width: 180px;">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr class="@(item.SvgAberto ? "table-primary" : "")"
                          data-text="@($"{item.Objeto} {item.Coordenador} {item.TipoOperacao} {item.OrdemServico}".ToLower())"
                          data-mes="@item.DataHoraCriacao.Month"
                          data-ano="@item.DataHoraCriacao.Year"
                          data-svgaberto="@(item.SvgAberto ? "1" : "0")">

                          <td>@item.DataHoraCriacao.ToString("dd/MM/yyyy HH:mm")</td>
                          <td>@item.DataHora.ToString("dd/MM/yyyy HH:mm")</td>
                          <td>@item.Objeto</td>
                          <td>@item.TipoOperacao</td>
                          <td>@item.OrdemServico</td>
                          <td>@item.Coordenador</td>
                          <td>@item.QtdVagasRestantes</td>
                         @*  <td>@(item.SvgAberto ? "Sim" : "Não")</td> *@

                          <td class="text-end">
                              <div class="dropdown">
                                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                          type="button"
                                          data-bs-toggle="dropdown"
                                          aria-expanded="false">
                                      Ações
                                  </button>

                                  <ul class="dropdown-menu dropdown-menu-end">
                                        <li>
                                          @if (item.SvgAberto)
                                          {
                                              <a class="dropdown-item text-success fw-semibold"
                                                 href="#"
                                                 data-bs-toggle="modal"
                                                 data-bs-target="#encerrarSvgModal"
                                                 data-id="@item.ID">
                                                  Encerrar SVG
                                              </a>
                                          }
                                          else
                                          {
                                              <span class="dropdown-item disabled text-muted">
                                                  Encerrar SVG
                                              </span>
                                          }
                                      </li>
                                      <li>
                                          <a class="dropdown-item"
                                             href="@Url.Action("DetalhesOperacao", "Operacao", new { pOperacaoID = item.ID })">
                                              Detalhes
                                          </a>
                                      </li>

                                      <li>
                                          <a class="dropdown-item"
                                             href="@Url.Action("Edit", "Operacao", new { id = item.ID })">
                                              Editar
                                          </a>
                                      </li>

                                      <li>
                                          <a class="dropdown-item"
                                             href="@Url.Action("Index", "Operacao", new { id = item.ID })">
                                              Escala
                                          </a>
                                      </li>

                                      <li><hr class="dropdown-divider"></li>

                                      <li>
                                          <a class="dropdown-item text-danger"
                                             href="@Url.Action("Delete", "Operacao", new { id = item.ID })"
                                             onclick="return confirm('Tem certeza que deseja excluir esta operação?');">
                                              Excluir
                                          </a>
                                      </li>
                                  </ul>
                              </div>
                          </td>
                      </tr>

                    }
                </tbody>
            </table>
        </div>

        <!-- ESTADO VAZIO (CLIENT-SIDE) -->
        <div id="estadoVazio"
             class="alert alert-info text-center py-4"
             style="display:none;">
            <h5 class="mb-2">Nenhuma operação encontrada</h5>
            <p class="mb-3 text-muted">
                Tente ajustar ou limpar os filtros aplicados.
            </p>

            <button type="button"
                    id="btnLimparFiltros"
                    class="btn btn-outline-primary">
                Limpar filtros
            </button>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center py-4">
            <h5 class="mb-2">Nenhuma operação encontrada</h5>
            <p class="mb-3 text-muted">
                Não há operações cadastradas no momento.
            </p>

            <a href="@Url.Action("Create", "Operacao")"
               class="btn btn-outline-primary">
                Criar nova operação
            </a>
        </div>
    }
</div>

@section Scripts {
    <script>
        const filtroTexto = document.getElementById('filtroOperacoes');
        const filtroMes = document.getElementById('filtroMes');
        const filtroAno = document.getElementById('filtroAno');
        const filtroSvgAberto = document.getElementById('filtroSvgAberto');

        const contadorExibidas = document.getElementById('contadorExibidas');
        const contadorTotal = document.getElementById('contadorTotal');

        const btnLimparTopo = document.getElementById('btnLimparFiltrosTopo');
        const btnLimpar = document.getElementById('btnLimparFiltros');

        const linhas = Array.from(document.querySelectorAll('tbody tr'));
        const containerTabela = document.getElementById('containerTabela');
        const estadoVazio = document.getElementById('estadoVazio');

        contadorTotal.textContent = linhas.length.toString();

        function aplicarFiltros() {
            const texto = (filtroTexto.value || '').toLowerCase();
            const mes = filtroMes.value;
            const ano = filtroAno.value;
            const svg = filtroSvgAberto ? filtroSvgAberto.value : ""; // NOVO

            let exibidas = 0;

            linhas.forEach(tr => {
                const textoLinha = tr.dataset.text || '';
                const mesLinha = tr.dataset.mes;
                const anoLinha = tr.dataset.ano;
                const svgLinha = tr.dataset.svgaberto; // NOVO

                const matchTexto = textoLinha.includes(texto);
                const matchMes = !mes || mes === mesLinha;
                const matchAno = !ano || ano === anoLinha;
                const matchSvg = !svg || svg === svgLinha; // NOVO

                const mostrar = matchTexto && matchMes && matchAno && matchSvg;

                tr.style.display = mostrar ? '' : 'none';
                if (mostrar) exibidas++;
            });

            contadorExibidas.textContent = exibidas.toString();

            if (exibidas === 0) {
                containerTabela.style.display = 'none';
                estadoVazio.style.display = 'block';
            } else {
                containerTabela.style.display = 'block';
                estadoVazio.style.display = 'none';
            }
        }

        function limparFiltros() {
            filtroTexto.value = '';
            filtroMes.value = '';
            filtroAno.value = '';
            if (filtroSvgAberto) filtroSvgAberto.value = ''; // NOVO
            aplicarFiltros();
        }

        filtroTexto.addEventListener('input', aplicarFiltros);
        filtroMes.addEventListener('change', aplicarFiltros);
        filtroAno.addEventListener('change', aplicarFiltros);
        if (filtroSvgAberto) filtroSvgAberto.addEventListener('change', aplicarFiltros); // NOVO

        btnLimparTopo.addEventListener('click', limparFiltros);
        if (btnLimpar) btnLimpar.addEventListener('click', limparFiltros);

        // inicializa
        aplicarFiltros();
    </script>
}
