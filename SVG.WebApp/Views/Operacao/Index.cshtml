@model IEnumerable<SVG.Domain.TiposEstruturados.TiposOperacao.OperacoesRealizadas>

@{
    ViewData["Title"] = "Operações";

    var anos = Model?
        .Select(m => m.DataHoraCriacao.Year)
        .Distinct()
        .OrderByDescending(a => a)
        .ToList() ?? new List<int>();

    var total = Model?.Count() ?? 0;
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Operações</h2>
        <a href="@Url.Action("Create", "Operacao")"
           class="btn btn-primary">
            Nova Operação
        </a>
    </div>

    <!-- FILTROS -->
    <div class="row g-2 mb-2">
        <div class="col-md-4">
            <input type="text"
                   id="filtroOperacoes"
                   class="form-control"
                   placeholder="Buscar por local, coordenador, tipo ou OS..." />
        </div>

        <div class="col-md-3">
            <select id="filtroMes" class="form-select">
                <option value="">Mês (todos)</option>
                <option value="1">Janeiro</option>
                <option value="2">Fevereiro</option>
                <option value="3">Março</option>
                <option value="4">Abril</option>
                <option value="5">Maio</option>
                <option value="6">Junho</option>
                <option value="7">Julho</option>
                <option value="8">Agosto</option>
                <option value="9">Setembro</option>
                <option value="10">Outubro</option>
                <option value="11">Novembro</option>
                <option value="12">Dezembro</option>
            </select>
        </div>

        <div class="col-md-2">
            <select id="filtroAno" class="form-select">
                <option value="">Ano (todos)</option>
                @foreach (var ano in anos)
                {
                    <option value="@ano">@ano</option>
                }
            </select>
        </div>
    </div>

    <!-- CONTADOR -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <small class="text-muted">
            Exibindo <strong><span id="contadorExibidas">@total</span></strong>
            de <strong><span id="contadorTotal">@total</span></strong> operações
        </small>

        <button type="button"
                id="btnLimparFiltrosTopo"
                class="btn btn-sm btn-outline-secondary">
            Limpar filtros
        </button>
    </div>

    @if (Model != null && Model.Any())
    {
        <div class="table-responsive" id="containerTabela">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Data/Hora Criação</th>
                        <th>Data/Hora</th>
                        <th>Local</th>
                        <th>Tipo</th>
                        <th>OS</th>
                        <th>Coordenador</th>
                        <th class="text-end" style="width: 180px;">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr data-text="@($"{item.Objeto} {item.Coordenador} {item.TipoOperacao} {item.OrdemServico}".ToLower())"
                            data-mes="@item.DataHoraCriacao.Month"
                            data-ano="@item.DataHoraCriacao.Year">
                            <td>@item.DataHoraCriacao.ToString("dd/MM/yyyy HH:mm")</td>
                            <td>@item.DataHora.ToString("dd/MM/yyyy HH:mm")</td>
                            <td>@item.Objeto</td>
                            <td>@item.TipoOperacao</td>
                            <td>@item.OrdemServico</td>
                            <td>@item.Coordenador</td>
                            <td class="text-end">
                                <div class="row g-1">
                                    <div class="col-6">
                                        <a href="@Url.Action("DetalhesOperacao", "Operacao", new { pOperacaoID = item.ID })"
                                           class="btn btn-sm btn-outline-primary w-100">
                                            Detalhes
                                        </a>
                                    </div>

                                    <div class="col-6">
                                        <a href="@Url.Action("Edit", "Operacao", new { id = item.ID })"
                                           class="btn btn-sm btn-outline-primary w-100">
                                            Editar
                                        </a>
                                    </div>

                                    <div class="col-6">
                                        <a href="@Url.Action("Index", "Operacao", new { id = item.ID })"
                                           class="btn btn-sm btn-outline-primary w-100">
                                            Escala
                                        </a>
                                    </div>

                                    <div class="col-6">
                                        <a href="@Url.Action("Delete", "Operacao", new { id = item.ID })"
                                           class="btn btn-sm btn-outline-danger w-100">
                                            Excluir
                                        </a>
                                    </div>
                                </div>
                            </td>

                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- ESTADO VAZIO (CLIENT-SIDE) -->
        <div id="estadoVazio"
             class="alert alert-info text-center py-4"
             style="display:none;">
            <h5 class="mb-2">Nenhuma operação encontrada</h5>
            <p class="mb-3 text-muted">
                Tente ajustar ou limpar os filtros aplicados.
            </p>

            <button type="button"
                    id="btnLimparFiltros"
                    class="btn btn-outline-primary">
                Limpar filtros
            </button>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center py-4">
            <h5 class="mb-2">Nenhuma operação encontrada</h5>
            <p class="mb-3 text-muted">
                Não há operações cadastradas no momento.
            </p>

            <a href="@Url.Action("Create", "Operacao")"
               class="btn btn-outline-primary">
                Criar nova operação
            </a>
        </div>
    }
</div>

@section Scripts {
    <script>
        const filtroTexto = document.getElementById('filtroOperacoes');
        const filtroMes = document.getElementById('filtroMes');
        const filtroAno = document.getElementById('filtroAno');

        const contadorExibidas = document.getElementById('contadorExibidas');
        const contadorTotal = document.getElementById('contadorTotal');

        const btnLimparTopo = document.getElementById('btnLimparFiltrosTopo');
        const btnLimpar = document.getElementById('btnLimparFiltros');

        const linhas = Array.from(document.querySelectorAll('tbody tr'));
        const containerTabela = document.getElementById('containerTabela');
        const estadoVazio = document.getElementById('estadoVazio');

        contadorTotal.textContent = linhas.length.toString();

        function aplicarFiltros() {
            const texto = (filtroTexto.value || '').toLowerCase();
            const mes = filtroMes.value;
            const ano = filtroAno.value;

            let exibidas = 0;

            linhas.forEach(tr => {
                const textoLinha = tr.dataset.text || '';
                const mesLinha = tr.dataset.mes;
                const anoLinha = tr.dataset.ano;

                const matchTexto = textoLinha.includes(texto);
                const matchMes = !mes || mes === mesLinha;
                const matchAno = !ano || ano === anoLinha;

                const mostrar = matchTexto && matchMes && matchAno;

                tr.style.display = mostrar ? '' : 'none';
                if (mostrar) exibidas++;
            });

            contadorExibidas.textContent = exibidas.toString();

            if (exibidas === 0) {
                containerTabela.style.display = 'none';
                estadoVazio.style.display = 'block';
            } else {
                containerTabela.style.display = 'block';
                estadoVazio.style.display = 'none';
            }
        }

        function limparFiltros() {
            filtroTexto.value = '';
            filtroMes.value = '';
            filtroAno.value = '';
            aplicarFiltros();
        }

        filtroTexto.addEventListener('input', aplicarFiltros);
        filtroMes.addEventListener('change', aplicarFiltros);
        filtroAno.addEventListener('change', aplicarFiltros);

        btnLimparTopo.addEventListener('click', limparFiltros);
        if (btnLimpar) btnLimpar.addEventListener('click', limparFiltros);

        // inicializa
        aplicarFiltros();
    </script>
}
