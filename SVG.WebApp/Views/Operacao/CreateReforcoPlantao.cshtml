@model SVG.App.ViewModels.OperacaoViewModel

@using SVG.Domain.Entities

@{
    ViewData["Title"] = "Reforço do Plantão";

    // Default no Create: SvgAberto = true (sem sobrescrever quando volta com ModelState inválido)
    if (!ViewContext.ViewData.ModelState.ContainsKey(nameof(Model.SvgAberto)))
    {
        Model.SvgAberto = true;
    }
    var operadoresJson = (string)ViewBag.OperadoresJson; 
    var tipos = (IEnumerable<TipoOperacao>)ViewBag.TiposOperacao;
}

<div class="container mt-4">
    <h2>Nova Operação de Reforço</h2>
    <hr />

    <form asp-action="Create" method="post" class="mt-3">
        <div asp-validation-summary="All" class="text-danger"></div>

        <div class="row g-3 align-items-end">
            <div class="col-md-2">
                <label asp-for="DataHoraInicio" class="form-label">Horário Início</label>
                <input asp-for="DataHoraInicio"
                       type="datetime-local"
                       name="DataHoraInicio"
                       class="form-control"
                       value="@Model.DataHoraInicio.ToString("yyyy-MM-ddTHH:mm")" />
                <span asp-validation-for="DataHoraInicio" class="text-danger"></span>
            </div>       


            <div class="col-md-2">
                <label asp-for="DataHoraFim" class="form-label">Horário Fim</label>
                <input asp-for="DataHoraFim"
                       type="datetime-local"
                       name="DataHoraFim"
                       class="form-control"
                       value="@Model.DataHoraFim.ToString("yyyy-MM-ddTHH:mm")" />
                <span asp-validation-for="DataHoraFim" class="text-danger"></span>
            </div>       


            <div class="col-md-1">
                <label asp-for="OrdemServico" class="form-label">OS</label>
                <input asp-for="OrdemServico" type="number" min="0" name="OrdemServico" placeholder="Ex.: 055" class="form-control" />
            </div>

            <!-- Objeto (reduzido) -->
            <div class="col-md-2">
                <label asp-for="Objeto" class="form-label">Objeto</label>
                <input asp-for="Objeto" name="Objeto" placeholder="Ex.: Segurança Orgânica" class="form-control" />
            </div>

            <!-- SVG Aberto -->
            <div class="col-md-1">
                <label class="form-label d-block">SVG</label>
                <div class="form-check form-switch mt-1">
                    <input class="form-check-input"
                           type="checkbox"
                           asp-for="SvgAberto"
                           id="SvgAbertoToggleTop" />
                    <label class="form-check-label" for="SvgAbertoToggleTop">
                        Aberto
                    </label>
                </div>
            </div>
            <!-- Tipo Operação (fixo) -->
            @{
                var tipoFixo = (tipos ?? Enumerable.Empty<TipoOperacao>()).FirstOrDefault(t => t.Nome == "Reforço de Plantão");
                var tipoFixoId = tipoFixo?.ID ?? Model.TipoOperacaoID;
                var tipoFixoNome = tipoFixo?.Nome ?? "Reforço de Plantão";
            }
            <div class="col-md-2">
                <label class="form-label">Tipo</label>
                <input type="text" class="form-control" value="@tipoFixoNome" disabled />
                <input type="hidden" name="TipoOperacaoID" value="@tipoFixoId" />
            </div>
        </div>

        <div class="row mt-4 g-3 align-items-start">

            <!-- VOLUNTÁRIOS -->
            <div class="col-12">
                <div class="card h-100">
                    <div class="card-header py-2">
                        Operadores para Operação
                    </div>

                    <div class="card-body p-3">

                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label mb-1">Buscar Operador</label>

                                <input type="text"
                                       id="operadorSearch"
                                       class="form-control mb-2"
                                       placeholder="Digite o nome para filtrar..." />

                                <div class="d-flex gap-2">
                                    <select id="operadorSelect" class="form-select form-select-sm flex-grow-1">
                                        <option value="">Selecione um operador...</option>
                                        @* opções serão preenchidas via JS usando operadoresJson *@
                                    </select>

                                    <button type="button"
                                            id="btnAddOperador"
                                            class="btn btn-primary btn-sm align-self-center"
                                            style="white-space: nowrap;">
                                        Adicionar
                                    </button>
                                </div>
                            </div>

                            <!-- Qtd Vagas SVG -->
                            <div class="col-md-4">
                                <label asp-for="QtdVagasVoluntarios" class="form-label mb-1">Vagas Totais SVG</label>
                                <input asp-for="QtdVagasVoluntarios"
                                       name="QtdVagasVoluntarios"
                                       type="number" min="0"
                                       class="form-control form-control-sm" />
                                <span asp-validation-for="QtdVagasVoluntarios" class="text-danger"></span>
                            </div>

                            <hr class="my-3" />

                            <div class="mb-2 d-flex align-items-center flex-wrap gap-2">
                                <strong>Operadores selecionados:</strong>
                                <span id="contadorOperadores" class="badge bg-primary">0</span>

                                <span class="ms-0 ms-md-3 d-flex align-items-center gap-2">
                                    <strong>SVG:</strong>
                                    <span id="contadorOperadoresSvg" class="badge bg-success">0</span>
                                </span>
                            </div>

                            <ul id="listaOperadoresSelecionados" class="list-group">
                                <!-- JS adiciona itens aqui -->
                            </ul>

                        </div>
                    </div>
                </div>
            </div>


            <div class="d-flex justify-content-between mt-4">
                <a asp-action="Index" class="btn btn-outline-secondary">Voltar</a>
                @* <button type="submit" class="btn btn-success">Salvar Operação</button> *@
                <button type="submit" id="btnSalvar" class="btn btn-primary" disabled>Salvar</button>
            </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>

          document.addEventListener("DOMContentLoaded", function () {
           const form = document.querySelector("form");
           const btnSalvar = document.getElementById("btnSalvar");

           // 1) Recria as regras unobtrusive
           $.validator.unobtrusive.parse(form);

           // 2) Pega o validator do form
           const validator = $(form).data("validator");
           console.log("Validator:", validator);

           function atualizarBotao() {
             const valido = $(form).valid();

             // DEBUG: quais campos estão errando
             if (!valido) {
               const v = $(form).validate();
               console.log("Campos com erro:", v.errorMap);
               console.log("Lista de erros:", v.errorList);
             }

             btnSalvar.disabled = !valido;
           }

           // Para aparecer erro quando o usuário mexer
           form.addEventListener("input", atualizarBotao);
           form.addEventListener("change", atualizarBotao);

           // Força mostrar mensagens ao tentar enviar
           form.addEventListener("submit", function (e) {
             if (!$(form).valid()) {
               e.preventDefault();
               $(form).validate().focusInvalid();
             }
           });

           // inicial
           atualizarBotao();
         });



         // Dados de operadores vindos do controller (ID, Nome, Matricula, SessaoID)
         const operadoresData = @Html.Raw(operadoresJson);
         const opSelect = document.getElementById('operadorSelect');
         function preencherComboVoluntarios() {
             operadoresData.forEach(op => {
                 const opt = document.createElement('option');
                 opt.value = op.ID;
                 opt.text = `${op.Nome} (${op.Matricula})`;
                 opSelect.appendChild(opt);
             });
         }
         preencherComboVoluntarios();        const listaSelecionados = document.getElementById('listaOperadoresSelecionados');
         const contadorOperadores = document.getElementById('contadorOperadores');
         const contadorOperadoresSvg = document.getElementById('contadorOperadoresSvg');

         function atualizarContadorOperadores() {
             // total
             const total = listaSelecionados.children.length;
             contadorOperadores.textContent = total;

             // somente os marcados como SVG (hidden input .inputSvgFlag == "true")
             const svgCount = listaSelecionados.querySelectorAll('.inputSvgFlag[value="true"]').length;
             contadorOperadoresSvg.textContent = svgCount;
         }


         // índice para OperadoresSelecionados[i]
         // let operadorIndex = 0;

        function renumerarSelecionados() {
             const itens = Array.from(listaSelecionados.children);
             const total = itens.length;

             itens.forEach((li, idx) => {
                 // numeração invertida (topo = maior número)
                 const badgeNum = li.querySelector('.badgeNumero');
                 if (badgeNum) badgeNum.textContent = (total - idx);

                 // renomeia inputs para ficar sequencial no POST
                 const inputId = li.querySelector('.inputOperadorId');
                 const inputSvg = li.querySelector('.inputSvgFlag');

                 if (inputId) inputId.name = `OperadoresSelecionados[${idx}].OperadorID`;
                 if (inputSvg) inputSvg.name = `OperadoresSelecionados[${idx}].SVG`;
             });

             atualizarContadorOperadores();
         }



         // Função comum para adicionar operador na lista final (sessão ou voluntário)
                 // Função comum para adicionar operador na lista final (sessão ou voluntário)
         function adicionarOperador(op, svgFlag) {
             const liId = 'op-' + op.ID;
             if (document.getElementById(liId)) return;

             const li = document.createElement('li');
             li.className = 'list-group-item d-flex justify-content-between align-items-center';
             li.id = liId;

             const tipo = svgFlag ? 'Voluntário' : 'Ordinário';
             const svgText = svgFlag ? 'SVG: Sim' : 'SVG: Não';
             const svgBtnClass = svgFlag ? 'btn-outline-success' : 'btn-outline-secondary';

             li.innerHTML = `
                 <div>
                     <span class="badge bg-secondary me-2 badgeNumero">1</span>
                     <strong>${op.Nome}</strong> (${op.Matricula})
                     <span class="badge bg-secondary ms-2 badgeTipo">${tipo}</span>
                 </div>

                 <div class="btn-group btn-group-sm" role="group">
                     <button type="button" class="btn ${svgBtnClass} btnToggleSvg">${svgText}</button>
                     <button type="button" class="btn btn-outline-danger btnRemoverOperador">Remover</button>
                 </div>

                 <input type="hidden" value="${op.ID}" class="inputOperadorId" />
                 <input type="hidden" value="${svgFlag}" class="inputSvgFlag" />
             `;

             // Remover
             li.querySelector('.btnRemoverOperador').addEventListener('click', function () {
                 li.remove();
                 renumerarSelecionados();
             });

             // Toggle SVG
             li.querySelector('.btnToggleSvg').addEventListener('click', function () {
                 const inputSvg = li.querySelector('.inputSvgFlag');
                 const atual = (inputSvg.value === "true");
                 const novo = !atual;

                 inputSvg.value = novo ? "true" : "false";

                 // texto + cor do botão SVG
                 this.textContent = novo ? "SVG: Sim" : "SVG: Não";
                 this.classList.toggle("btn-outline-success", novo);
                 this.classList.toggle("btn-outline-secondary", !novo);

                 // >>> troca Ordinário/Voluntário junto com o SVG
                 const badgeTipo = li.querySelector('.badgeTipo');
                 if (badgeTipo) {
                     badgeTipo.textContent = novo ? "Voluntário" : "Ordinário";
                 }

                 atualizarContadorOperadores();
             });

             listaSelecionados.prepend(li);
             renumerarSelecionados();

             // destaque temporário (flash) no item recém adicionado
             li.classList.remove('op-added'); // garante re-trigger
             void li.offsetWidth;             // força reflow para reiniciar animação
             li.classList.add('op-added');
         }

         // --- Voluntários: filtro inteligente + adicionar individual (SVG = true)
         const opSearch = document.getElementById('operadorSearch');

         opSearch.addEventListener('input', function () {
             const termo = this.value.trim().toLowerCase();

             let firstMatchIndex = -1;
             let matchCount = 0;

             for (let i = 0; i < opSelect.options.length; i++) {
                 const opt = opSelect.options[i];

                 if (!opt.value) {
                     opt.hidden = false;
                     continue;
                 }

                 const texto = opt.text.toLowerCase();
                 const match = termo === "" || texto.includes(termo);

                 opt.hidden = !match;

                 if (match) {
                     matchCount++;
                     if (firstMatchIndex === -1) {
                         firstMatchIndex = i;
                     }
                 }
             }

             if (termo === "") {
                 opSelect.selectedIndex = 0;
                 opSelect.size = 1;
                 return;
             }

             if (matchCount === 1 && firstMatchIndex !== -1) {
                 opSelect.selectedIndex = firstMatchIndex;
                 opSelect.size = 1;
             } else if (matchCount > 1) {
                 opSelect.selectedIndex = firstMatchIndex;
                 opSelect.size = Math.min(matchCount + 1, 8);
             } else {
                 opSelect.selectedIndex = 0;
                 opSelect.size = 1;
             }
         });

         opSearch.addEventListener('blur', function () {
             opSelect.size = 1;
         });

         const btnAddOperador = document.getElementById('btnAddOperador');
         btnAddOperador.addEventListener('click', function () {
             const opt = opSelect.options[opSelect.selectedIndex];
             if (!opt || !opt.value) return;

             const id = parseInt(opt.value);
             const op = operadoresData.find(o => o.ID === id);
             if (op) {
                 adicionarOperador(op, true); // voluntário
             }
         });



    </script>
}

<style>
    .op-added {
        animation: opAddedGlow 1.5s ease-out;
    }

    @@keyframes opAddedGlow {
        0% {
            box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.55);
            border-left: 4px solid rgba(25,135,84,0.9);
        }

        100% {
            box-shadow: 0 0 0 10px rgba(25, 135, 84, 0);
            border-left: 4px solid transparent;
        }
    }
</style>