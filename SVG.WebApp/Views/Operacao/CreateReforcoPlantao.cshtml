@model SVG.App.ViewModels.OperacaoViewModel
@using SVG.Domain.Entities
@using System.Globalization

@{
    ViewData["Title"] = "Segurança Orgânica";

    // Tipos de operação (para fixar Segurança Orgânica)
    var tipos = (IEnumerable<TipoOperacao>)ViewBag.TiposOperacao ?? Enumerable.Empty<TipoOperacao>();

    // tenta achar o tipo "Segurança Orgânica" (com/sem acento)
    var tipoSegurancaOrganica =
        tipos.FirstOrDefault(t => (t.Nome ?? "").Equals("Segurança Orgânica", StringComparison.OrdinalIgnoreCase))
        ?? tipos.FirstOrDefault(t => (t.Nome ?? "").Equals("Seguranca Organica", StringComparison.OrdinalIgnoreCase));

    var tipoOperacaoIdFixado = (tipoSegurancaOrganica != null ? tipoSegurancaOrganica.ID : Model.TipoOperacaoID);
}

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Criar Operação – Segurança Orgânica</h2>
        <a asp-action="Index" asp-controller="Operacao" class="btn btn-sm btn-outline-secondary">Voltar</a>
    </div>

    <!-- ======================
         FORM (apenas para agrupar inputs + antiforgery)
         NÃO será submetido por submit.
         ====================== -->
    <form id="formCriarOperacao" class="card" method="post" action="@Url.Action("CreateReforcoPlantao", "Operacao")">

       <div asp-validation-summary="All" class="text-danger"></div>
        @Html.AntiForgeryToken()

        <div class="card-header py-2">
            Preencha os campos e clique em <strong>Adicionar</strong>
        </div>

        <div class="card-body">
            <div asp-validation-summary="All" class="text-danger"></div>

            <!-- Tipo fixo -->
            <input type="hidden" id="TipoOperacaoID" name="TipoOperacaoID" value="@tipoOperacaoIdFixado" />

            <div class="row g-2 align-items-end">

                <!-- OS (somente números) -->
                <div class="col-md-1">
                    <label asp-for="OrdemServico" class="form-label">OS</label>
                    <input asp-for="OrdemServico"
                           id="OrdemServico"
                           name="OrdemServico"
                           class="form-control"
                           inputmode="numeric"
                           pattern="[0-9]*"
                           maxlength="12"
                           placeholder="Ex.: 556" />
                </div>

                <!-- Início -->
                <div class="col-md-2">
                    <label asp-for="DataHoraInicio" class="form-label">Horário Início</label>
                    <input asp-for="DataHoraInicio"
                           id="DataHoraInicio"
                           name="DataHoraInicio"
                           type="datetime-local"
                           class="form-control"
                           value="@(Model.DataHoraInicio == default(DateTime) ? "" : Model.DataHoraInicio.ToString("dd/MMTHH:mm"))" />
                </div>

                <!-- Fim -->
                <div class="col-md-2">
                    <label asp-for="DataHoraFim" class="form-label">Horário Fim</label>
                    <input asp-for="DataHoraFim"
                           id="DataHoraFim"
                           name="DataHoraFim"
                           type="datetime-local"
                           class="form-control"
                           value="@(Model.DataHoraFim == default(DateTime) ? "" : Model.DataHoraFim.ToString("dd/MMTHH:mm"))" />
                </div>

                <!-- Objeto (menor) -->
                <div class="col-md-3">
                    <label asp-for="Objeto" class="form-label">Descrição / Objeto</label>
                    <input asp-for="Objeto"
                           id="Objeto"
                           name="Objeto"
                           class="form-control"
                           placeholder="Ex.: Posto 01 – Entrada principal" />
                </div>

                <!-- Vagas (readonly = 1) -->
                <div class="col-md-1">
                    <label asp-for="QtdVagasVoluntarios" class="form-label">Vagas</label>
                    <input asp-for="QtdVagasVoluntarios"
                           id="QtdVagasVoluntarios"
                           name="QtdVagasVoluntarios"
                           type="number"
                           class="form-control"
                           value="1"
                           readonly />
                </div>

                <!-- SVG aberto -->
                <div class="col-md-1">
                    <label class="form-label d-block">SVG</label>
                    <div class="form-check mt-2">
                        <input asp-for="SvgAberto" class="form-check-input" type="checkbox" id="SvgAberto" name="SvgAberto" />
                        <label class="form-check-label" for="SvgAberto">Sim</label>
                    </div>
                </div>

                <div class="col-12 d-flex justify-content-end gap-2">
                    <button type="button" id="btnCarregar" class="btn btn-outline-secondary">
                        Carregar por OS
                    </button>

                    <!-- IMPORTANTE: não submit -->
                    <button type="button" id="btnAdicionar" class="btn btn-primary">
                        Adicionar
                    </button>
                </div>
            </div>
        </div>
    </form>

    <!-- ======================
         LISTA: OPERAÇÕES CRIADAS (pela OS)
         ====================== -->
    <div class="card mt-3">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span>Operações criadas para a OS <strong id="osAtual">—</strong></span>
            <span class="badge bg-secondary">Total: <span id="totalOps">0</span></span>
        </div>

        <div class="card-body p-0">
            <div id="estadoLista" class="p-3">
                <div class="text-muted">Informe uma OS e clique em <strong>Carregar por OS</strong>.</div>
            </div>

            <div class="table-responsive" id="wrapTabela" style="display:none;">
                <table class="table table-sm align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center" style="width: 80px;">ID</th>
                            <th class="text-center" style="width: 170px;">Início</th>
                            <th class="text-center" style="width: 170px;">Fim</th>
                            <th class="text-center">Objeto</th>
                            <th style="width: 90px;" class="text-center">Vagas</th>
                            <th style="width: 220px;" class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyOps">
                        <!-- preenchido via JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const form = document.getElementById("formCriarOperacao");

            const btnCarregar = document.getElementById("btnCarregar");
            const btnAdicionar = document.getElementById("btnAdicionar");

            const estadoLista = document.getElementById("estadoLista");
            const wrapTabela = document.getElementById("wrapTabela");
            const tbodyOps = document.getElementById("tbodyOps");
            const osAtual = document.getElementById("osAtual");
            const totalOps = document.getElementById("totalOps");

            const inputOs = document.getElementById("OrdemServico");
            const inputVagas = document.getElementById("QtdVagasVoluntarios");
            const inputTipo = document.getElementById("TipoOperacaoID");

            const criarUrl = form.getAttribute("action");

            let osSelecionada = "";

            function getAntiForgeryToken() {
                const input = form.querySelector('input[name="__RequestVerificationToken"]');
                return input ? input.value : "";
            }

            function getOs() {
                const v = (inputOs?.value || "");
                return (v && v.trim()) ? v.trim() : "";
            }

            function setInfo(msgHtml) {
                estadoLista.style.display = "block";
                wrapTabela.style.display = "none";
                estadoLista.innerHTML = `<div class="p-3"><div class="alert alert-info mb-0">${msgHtml}</div></div>`;
            }

            function setLoading(msg) {
                estadoLista.style.display = "block";
                wrapTabela.style.display = "none";
                estadoLista.innerHTML = `<div class="p-3 text-muted">${msg}</div>`;
            }

            function setError(msgHtml) {
                estadoLista.style.display = "block";
                wrapTabela.style.display = "none";
                estadoLista.innerHTML = `<div class="p-3"><div class="alert alert-danger mb-0">${msgHtml}</div></div>`;
            }

            function formatarDataHora(v) {
    if (!v) return "";

    let d;

    // MVC clássico: "/Date(1704373200000)/"
    if (typeof v === "string" && v.startsWith("/Date(")) {
        const ms = parseInt(v.replace("/Date(", "").replace(")/", ""), 10);
        d = new Date(ms);
    } else {
        d = new Date(v);
    }

    if (isNaN(d.getTime())) return "";

    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mi = String(d.getMinutes()).padStart(2, "0");

    return `${dd}/${mm} ${hh}:${mi}`;
}


            function pick(obj, pascal, camel) {
                if (!obj) return null;
                if (obj[pascal] !== undefined && obj[pascal] !== null) return obj[pascal];
                if (obj[camel] !== undefined && obj[camel] !== null) return obj[camel];
                return null;
            }

            async function carregarOperacoesPorOS() {
                osAtual.textContent = osSelecionada || "—";

                if (!osSelecionada) {
                    setInfo("Informe uma OS e clique em <strong>Carregar por OS</strong>.");
                    return;
                }

                setLoading("Carregando operações...");

                try {
                    // ✅ Tenta com pOrdemServico (seu controller) e fallback com ordemServico
                    let url = `/Operacao/ListarOperacoesPorOrdemServico?pOrdemServico=${encodeURIComponent(osSelecionada)}`;
                    let resp = await fetch(url, { method: "GET" });

                    if (!resp.ok) {
                        url = `/Operacao/ListarOperacoesPorOrdemServico?ordemServico=${encodeURIComponent(osSelecionada)}`;
                        resp = await fetch(url, { method: "GET" });
                    }

                    if (!resp.ok) {
                        setError(`Falha ao carregar lista. Status: <strong>${resp.status} ${resp.statusText}</strong>`);
                        return;
                    }

                    const itens = await resp.json();

                    totalOps.textContent = (itens || []).length;

                    if (!itens || itens.length === 0) {
                        setInfo("Nenhuma operação encontrada para esta OS.");
                        return;
                    }

                    tbodyOps.innerHTML = "";

                    itens.forEach(op => {
                        const tr = document.createElement("tr");

                        const id = pick(op, "ID", "id");
                        const dhInicio = pick(op, "DataHoraInicio", "dataHoraInicio");
                        const dhFim = pick(op, "DataHoraFim", "dataHoraFim");
                        const objeto = pick(op, "Objeto", "objeto") ?? "";
                        const vagas = pick(op, "QtdVagasRestantes", "qtdVagasRestantes") ?? 0;

                        tr.innerHTML = `
                            <td><strong>#${id}</strong></td>
                                    <td class="small text-muted text-center">${formatarDataHora(dhInicio)}</td>
                                    <td class="small text-muted text-center">${formatarDataHora(dhFim)}</td>
                                    <td class="small text-muted text-center">${objeto}</td>
                                    <td class="small text-muted text-center">${vagas}</td>
                                    <td class="small text-muted text-center">
                              ${id
                                        ? `<a class="btn btn-sm btn-danger text-center" href="/Operacao/Delete?id=${id}">Remover</a>`
                                        : `<span class="text-muted text-center">—</span>`}
                            </td>
                        `;

                        tbodyOps.appendChild(tr);
                    });

                    estadoLista.style.display = "none";
                    wrapTabela.style.display = "block";

                } catch (e) {
                    console.error(e);
                    setError("Erro ao carregar. Verifique sua conexão e o endpoint.");
                }
            }

            // OS: somente números (como você quer buscar por 222)
            if (inputOs) {
                inputOs.addEventListener("input", function () {
                    this.value = (this.value || "").replace(/\D/g, "");
                });

                inputOs.addEventListener("keydown", function (e) {
                    if (e.key === "Enter") {
                        e.preventDefault();
                        btnCarregar.click();
                    }
                });
            }

            // Vagas sempre 1
            if (inputVagas) inputVagas.value = 1;

            // Carregar por OS
            btnCarregar.addEventListener("click", function () {
                const os = getOs();
                osSelecionada = os || "";
                carregarOperacoesPorOS();
            });

            // Adicionar: chama serviço Create (POST) e depois recarrega lista do serviço
            btnAdicionar.addEventListener("click", async function () {

                if (window.jQuery && window.jQuery.validator) {
                    if (!$(form).valid()) return;
                }

                const os = getOs();
                if (!os) {
                    setInfo("Informe uma OS válida antes de adicionar.");
                    return;
                }

                osSelecionada = os;

                if (inputVagas) inputVagas.value = 1;

                const formData = new FormData(form);
                formData.set("TipoOperacaoID", inputTipo?.value || "");
                formData.set("QtdVagasVoluntarios", "1");
                formData.set("OrdemServico", os);

                try {
                    setLoading("Adicionando operação...");

                    const resp = await fetch(criarUrl, {
                        method: "POST",
                        body: formData,
                        headers: { "RequestVerificationToken": getAntiForgeryToken() }
                    });

                    if (!resp.ok) {
                        const txt = await resp.text();
                        setError(`Falha ao adicionar operação.
                                  <br/>Status: <strong>${resp.status} ${resp.statusText}</strong>
                                  <br/><small class="text-muted">${(txt || "").substring(0, 400)}</small>`);
                        return;
                    }

                    // Limpa campos por-operação
                    const inInicio = document.getElementById("DataHoraInicio");
                    const inFim = document.getElementById("DataHoraFim");
                    const inObj = document.getElementById("Objeto");

                    if (inInicio) inInicio.value = "";
                    if (inFim) inFim.value = "";
                    if (inObj) inObj.value = "";
                    if (inputVagas) inputVagas.value = 1;

                    // ✅ Recarrega SEMPRE do serviço (fonte da verdade)
                    await carregarOperacoesPorOS();

                } catch (e) {
                    console.error(e);
                    setError("Erro ao adicionar. Verifique sua conexão e o endpoint de criação.");
                }
            });

            // estado inicial
            setInfo("Informe uma OS e clique em <strong>Carregar por OS</strong>.");
        });
    </script>


}
