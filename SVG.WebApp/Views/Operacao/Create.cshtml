@model SVG.App.ViewModels.OperacaoViewModel

@using SVG.Domain.Entities

@{
    ViewData["Title"] = "Nova Operação";

    var coordenadores = (IEnumerable<Operador>)ViewBag.Coordenadores;
    var operadoresJson = (string)ViewBag.OperadoresJson;
    var sessoes = (IEnumerable<Sessao>)ViewBag.Sessoes;
    var tipos = (IEnumerable<TipoOperacao>)ViewBag.TiposOperacao;
}

<div class="container mt-4">
    <h2>Nova Operação</h2>
    <hr />

    <form asp-action="Create" method="post" class="mt-3">
        <!-- LINHA SUPERIOR: DataHora, Objeto, DP, Coordenador, QtdEquipe, TipoOperacao -->
        <div class="row mb-3">

            <!-- Data / Hora -->
            <div class="col-md-2">
                <label asp-for="DataHora" class="form-label">Data / Hora</label>
                <input asp-for="DataHora"
                       type="datetime-local"
                       name="DataHora"
                       class="form-control"
                       value="@Model.DataHora.ToString("yyyy-MM-ddTHH:mm")" />
                <span asp-validation-for="DataHora" class="text-danger"></span>
            </div>

            <!-- Objeto (reduzido) -->
            <div class="col-md-2">
                <label asp-for="Objeto" class="form-label">Objeto</label>
                <input asp-for="Objeto" name="Objeto" class="form-control" />
                <span asp-validation-for="Objeto" class="text-danger"></span>
            </div>

            <!-- DP Apoio (reduzido) -->
            <div class="col-md-1">
                <label asp-for="DP" class="form-label">DP Apoio</label>
                <input asp-for="DP" name="DP" class="form-control" />
                <span asp-validation-for="DP" class="text-danger"></span>
            </div>

            <!-- Coordenador (combo com busca em memória) -->
            <div class="col-md-3">
                <label class="form-label">Coordenador</label>
                <input type="text" id="coordenadorSearch" class="form-control mb-2"
                       placeholder="Buscar coordenador..." />

                <select id="coordenadorSelect"
                        name="CoordenadorOperadorID"
                        class="form-select">
                    <option value="">Selecione...</option>
                    @foreach (var op in coordenadores)
                    {
                        <option value="@op.ID"
                                @(Model.CoordenadorOperadorID == op.ID ? "selected" : "")>
                            @op.Nome (@op.Matricula)
                        </option>
                    }
                </select>
                <span asp-validation-for="CoordenadorOperadorID" class="text-danger"></span>
            </div>

            <!-- Qtd Equipes -->
            <div class="col-md-1">
                <label asp-for="QtdEquipe" class="form-label">Qtd</label>
                <input asp-for="QtdEquipe" name="QtdEquipe" type="number" min="1" class="form-control" />
                <span asp-validation-for="QtdEquipe" class="text-danger"></span>
            </div>

            <!-- Tipo Operação -->
            <div class="col-md-3">
                <label asp-for="TipoOperacaoID" class="form-label">Tipo</label>
                <select id="tipoOperacaoSelect"
                        name="TipoOperacaoID"
                        class="form-select">
                    <option value="">...</option>
                    @foreach (var t in tipos)
                    {
                        <option value="@t.ID"
                                @(Model.TipoOperacaoID == t.ID ? "selected" : "")>
                            @t.Nome
                        </option>
                    }
                </select>
                <span asp-validation-for="TipoOperacaoID" class="text-danger"></span>
            </div>

        </div>

        <!-- PAINEL DIVIDIDO EM DOIS LADOS -->
        <div class="row mt-4">

            <!-- LADO ESQUERDO: Sessões -> operadores automaticamente -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        Operadores por Sessão
                    </div>
                    <div class="card-body">

                        <div class="row mb-3">
                            <div class="col-8">
                                <label class="form-label">Selecionar Sessão</label>
                                <select id="sessaoSelect" class="form-select">
                                    <option value="">Escolha a sessão...</option>
                                    @foreach (var s in sessoes)
                                    {
                                        <option value="@s.ID">@s.Nome</option>
                                    }
                                </select>
                            </div>
                            <div class="col-4 d-flex align-items-end">
                                <button type="button" id="btnAddSessao" class="btn btn-primary w-100">
                                    Carregar sessão
                                </button>
                            </div>
                        </div>

                        <div class="mb-2">
                            <strong>Operadores da sessão selecionada:</strong>
                        </div>

                        <ul id="listaOperadoresSessao" class="list-group">
                            <!-- JS mostra operadores da sessão atual aqui (visual) -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- LADO DIREITO: Operadores voluntários (busca + seleção) -->
            <div class="col-md-6 mt-3 mt-md-0">
                <div class="card h-100">
                    <div class="card-header">
                        Operadores voluntários
                    </div>
                    <div class="card-body">

                        <div class="row mb-3">
                            <div class="col-md-8">
                                <label class="form-label">Buscar Operador</label>
                                <input type="text" id="operadorSearch" class="form-control mb-2"
                                       placeholder="Digite o nome para filtrar..." />

                                <div class="d-flex gap-2">
                                    <select id="operadorSelect" class="form-select form-select-sm flex-grow-1">
                                        <option value="">Selecione um operador...</option>
                                        @* opções serão preenchidas via JS usando operadoresJson *@
                                    </select>

                                    <button type="button"
                                            id="btnAddOperador"
                                            class="btn btn-primary btn-sm align-self-center"
                                            style="white-space: nowrap;">
                                        Adicionar
                                    </button>
                                </div>
                            </div>

                            <!-- Qtd Vagas SVG -->
                            <div class="col-md-4">
                                <label asp-for="QtdVagasVoluntarios" class="form-label">Qtd Vagas SVG</label>
                                <input asp-for="QtdVagasVoluntarios"
                                       name="QtdVagasVoluntarios"
                                       type="number" min="0"
                                       class="form-control" />
                                <span asp-validation-for="QtdVagasVoluntarios" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-2 d-flex align-items-center">
                            <strong>Operadores selecionados (sessão + voluntários):</strong>
                            <span id="contadorOperadores" class="badge bg-primary ms-2">0</span>
                        </div>
                        <ul id="listaOperadoresSelecionados" class="list-group">
                            <!-- JS adiciona itens aqui -->
                        </ul>

                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between mt-4">
            <a asp-action="Index" class="btn btn-outline-secondary">Voltar</a>
            <button type="submit" class="btn btn-success">Salvar Operação</button>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        // Dados de operadores vindos do controller (ID, Nome, Matricula, SessaoID)
        const operadoresData = @Html.Raw(operadoresJson);

        // --- Coordenador: filtro inteligente em memória (busca + seleção automática)
        const coordSearch = document.getElementById('coordenadorSearch');
        const coordSelect = document.getElementById('coordenadorSelect');

        coordSearch.addEventListener('input', function () {
            const termo = this.value.trim().toLowerCase();

            let firstMatchIndex = -1;
            let matchCount = 0;

            for (let i = 0; i < coordSelect.options.length; i++) {
                const opt = coordSelect.options[i];

                if (!opt.value) {
                    opt.hidden = false;
                    continue;
                }

                const texto = opt.text.toLowerCase();
                const match = termo === "" || texto.includes(termo);

                opt.hidden = !match;

                if (match) {
                    matchCount++;
                    if (firstMatchIndex === -1) {
                        firstMatchIndex = i;
                    }
                }
            }

            if (termo === "") {
                coordSelect.selectedIndex = 0;
                coordSelect.size = 1;
                return;
            }

            if (matchCount === 1 && firstMatchIndex !== -1) {
                coordSelect.selectedIndex = firstMatchIndex;
                coordSelect.size = 1;
            } else if (matchCount > 1) {
                coordSelect.selectedIndex = firstMatchIndex;
                coordSelect.size = Math.min(matchCount + 1, 8);
            } else {
                coordSelect.selectedIndex = 0;
                coordSelect.size = 1;
            }
        });

        coordSearch.addEventListener('blur', function () {
            coordSelect.size = 1;
        });

        // --- Preencher combo de voluntários com todos operadores
        const opSelect = document.getElementById('operadorSelect');
        function preencherComboVoluntarios() {
            operadoresData.forEach(op => {
                const opt = document.createElement('option');
                opt.value = op.ID;
                opt.text = `${op.Nome} (${op.Matricula})`;
                opSelect.appendChild(opt);
            });
        }
        preencherComboVoluntarios();

        const listaSessao = document.getElementById('listaOperadoresSessao');
        const listaSelecionados = document.getElementById('listaOperadoresSelecionados');
        const contadorOperadores = document.getElementById('contadorOperadores');

        function atualizarContadorOperadores() {
            const qtd = listaSelecionados.children.length;
            contadorOperadores.textContent = qtd;
        }

        // índice para OperadoresSelecionados[i]
        let operadorIndex = 0;

        // Função comum para adicionar operador na lista final (sessão ou voluntário)
        function adicionarOperador(op, svgFlag) {
            const liId = 'op-' + op.ID;
            if (document.getElementById(liId)) {
                // já está na lista, não duplica
                return;
            }

            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.id = liId;

            const tipo = svgFlag ? 'Voluntário' : 'Sessão';

            li.innerHTML = `
                <div>
                    <strong>${op.Nome}</strong> (${op.Matricula})
                    <span class="badge bg-secondary ms-2">${tipo}</span>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger">X</button>

                <input type="hidden" name="OperadoresSelecionados[${operadorIndex}].OperadorID" value="${op.ID}" />
                <input type="hidden" name="OperadoresSelecionados[${operadorIndex}].SVG" value="${svgFlag}" />
            `;

            operadorIndex++;

            li.querySelector('button').addEventListener('click', function () {
                li.remove();
                atualizarContadorOperadores();
            });

            listaSelecionados.appendChild(li);
            atualizarContadorOperadores();
        }

        // --- Sessão -> adiciona todos operadores daquela sessão (SVG = false)
        const sessaoSelect = document.getElementById('sessaoSelect');
        const btnAddSessao = document.getElementById('btnAddSessao');

        btnAddSessao.addEventListener('click', function () {
            const sessaoId = parseInt(sessaoSelect.value);
            if (!sessaoId) return;

            const ops = operadoresData.filter(o => o.SessaoID === sessaoId);

            // mostra apenas para visualização à esquerda
            listaSessao.innerHTML = '';
            ops.forEach(op => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = `${op.Nome} (${op.Matricula})`;
                listaSessao.appendChild(li);
            });

            // adiciona na lista final (sessão)
            ops.forEach(op => adicionarOperador(op, false));
        });

        // --- Voluntários: filtro inteligente + adicionar individual (SVG = true)
        const opSearch = document.getElementById('operadorSearch');

        opSearch.addEventListener('input', function () {
            const termo = this.value.trim().toLowerCase();

            let firstMatchIndex = -1;
            let matchCount = 0;

            for (let i = 0; i < opSelect.options.length; i++) {
                const opt = opSelect.options[i];

                if (!opt.value) {
                    opt.hidden = false;
                    continue;
                }

                const texto = opt.text.toLowerCase();
                const match = termo === "" || texto.includes(termo);

                opt.hidden = !match;

                if (match) {
                    matchCount++;
                    if (firstMatchIndex === -1) {
                        firstMatchIndex = i;
                    }
                }
            }

            if (termo === "") {
                opSelect.selectedIndex = 0;
                opSelect.size = 1;
                return;
            }

            if (matchCount === 1 && firstMatchIndex !== -1) {
                opSelect.selectedIndex = firstMatchIndex;
                opSelect.size = 1;
            } else if (matchCount > 1) {
                opSelect.selectedIndex = firstMatchIndex;
                opSelect.size = Math.min(matchCount + 1, 8);
            } else {
                opSelect.selectedIndex = 0;
                opSelect.size = 1;
            }
        });

        opSearch.addEventListener('blur', function () {
            opSelect.size = 1;
        });

        const btnAddOperador = document.getElementById('btnAddOperador');
        btnAddOperador.addEventListener('click', function () {
            const opt = opSelect.options[opSelect.selectedIndex];
            if (!opt || !opt.value) return;

            const id = parseInt(opt.value);
            const op = operadoresData.find(o => o.ID === id);
            if (op) {
                adicionarOperador(op, true); // voluntário
            }
        });
    </script>
}
