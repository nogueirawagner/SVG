@model SVG.App.ViewModels.OperacaoViewModel

@using SVG.Domain.Entities

@{
    ViewData["Title"] = "Nova Operação";

    // Default no Create: SvgAberto = true (sem sobrescrever quando volta com ModelState inválido)
    if (!ViewContext.ViewData.ModelState.ContainsKey(nameof(Model.SvgAberto)))
    {
        Model.SvgAberto = true;
    }

    var coordenadores = (IEnumerable<Operador>)ViewBag.Coordenadores;
    var operadoresJson = (string)ViewBag.OperadoresJson;
    var sessoes = (IEnumerable<Sessao>)ViewBag.Sessoes;
    var tipos = (IEnumerable<TipoOperacao>)ViewBag.TiposOperacao;

    var sessaoSelecionadaId = (int)(ViewBag.SessaoSelecionadaId ?? 0);
}

<div class="container mt-4">
    <h2>Nova Operação</h2>
    <hr />

    <form asp-action="Create" method="post" class="mt-3">
        <div asp-validation-summary="All" class="text-danger"></div>
        <div class="mb-3 fw-semibold">
            Plantão:
            <span class="text-primary">@ViewBag.PlantaoHoje</span>
            |
            Amanhã:
            <span class="text-success">@ViewBag.PlantaoAmanha</span>
            |
            Fantasma:
            <span class="text-muted">@ViewBag.PlantaoFantasma</span>
        </div>

        <div class="row g-3 align-items-end">
            <!-- Data / Hora -->
            <div class="col-md-2">
                <label asp-for="DataHora" class="form-label">Data / Hora</label>
                <input asp-for="DataHora"
                       type="datetime-local"
                       name="DataHora"
                       class="form-control"
                       value="@Model.DataHora.ToString("yyyy-MM-ddTHH:mm")" />
                <span asp-validation-for="DataHora" class="text-danger"></span>
            </div>

            <!-- Objeto (reduzido) -->
            <div class="col-md-3">
                <label asp-for="Objeto" class="form-label">Local</label>
                <input asp-for="Objeto" name="Objeto" placeholder="Ex.: Apoio ao DECOR" class="form-control" />
            </div>

            <!-- DP Apoio (reduzido) -->
            <div class="col-md-1">
                <label asp-for="OrdemServico" class="form-label">OS</label>
                <input asp-for="OrdemServico" type="number" min="0" name="OrdemServico" placeholder="Ex.: 055" class="form-control" />
            </div>

            <!-- Coordenador (combo com busca em memória) -->
            <div class="col-md-3">
                <label class="form-label">Coordenador</label>
                <input type="text" id="coordenadorSearch" class="form-control mb-2"
                       placeholder="Buscar coordenador..." />
            
                <select asp-for="CoordenadorOperadorID" id="coordenadorSelect" class="form-select">
                    <option value="">Selecione...</option>
                    @foreach (var op in ViewBag.Coordenadores as IEnumerable<dynamic>)
                    {
                        <option value="@op.ID">@op.Nome</option>
                    }
                </select>
            </div>


            <!-- Tipo Operação -->
           <div class="col-md-3">
                <label asp-for="TipoOperacaoID" class="form-label">Tipo</label>
                <select asp-for="TipoOperacaoID" class="form-select" id="TipoOperacaoID">
                    <option value="">Selecione...</option>
                    @foreach (var t in ViewBag.TiposOperacao as IEnumerable<dynamic>)
                    {
                        <option value="@t.ID">@t.Nome</option>
                    }
                </select>
            </div>
        </div>

        <div class="row mt-4 g-3 align-items-start">
            <!-- LADO ESQUERDO: Sessões -> operadores automaticamente (40%) -->
            <div class="col-12 col-lg-5">
                <div class="card h-100">
                    <div class="card-header py-2">
                        Seção
                    </div>

                    <!-- Mais compacto verticalmente -->
                    <div class="card-body p-2">

                        <div class="row g-2 align-items-end">
                            <div class="col-8">
                                <label class="form-label mb-1">Selecionar Seção</label>
                                <select id="sessaoSelect" class="form-select form-select-sm">
                                    <option value="">Escolha a seção...</option>
                                    @foreach (var s in sessoes)
                                    {
                                        if (s.ID == sessaoSelecionadaId)
                                        {
                                            <option value="@s.ID" selected="selected">@s.Nome</option>
                                        }
                                        else
                                        {
                                            <option value="@s.ID">@s.Nome</option>
                                        }
                                    }
                                </select>
                            </div>

                            <div class="col-4">
                                <button type="button" id="btnAddSessao" class="btn btn-primary btn-sm w-100">
                                    Adicionar Operadores
                                </button>
                            </div>
                        </div>

                        <hr class="my-2" />

                        <div class="mb-2">
                            <strong>Operadores da seção selecionada:</strong>
                        </div>

                        <ul id="listaOperadoresSessao" class="list-group">
                            <!-- JS mostra operadores da seção atual aqui (visual) -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- LADO DIREITO: Operadores voluntários (60%) -->
            <div class="col-12 col-lg-7">
                <div class="card h-100">
                    <div class="card-header py-2">
                        Operadores para Operação
                    </div>

                    <div class="card-body p-3">

                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label mb-1">Buscar Operador</label>

                                <input type="text"
                                       id="operadorSearch"
                                       class="form-control mb-2"
                                       placeholder="Digite o nome para filtrar..." />

                                <div class="d-flex gap-2">
                                    <select id="operadorSelect" class="form-select form-select-sm flex-grow-1">
                                        <option value="">Selecione um operador...</option>
                                        @* opções serão preenchidas via JS usando operadoresJson *@
                                    </select>

                                    <button type="button"
                                            id="btnAddOperador"
                                            class="btn btn-primary btn-sm align-self-center"
                                            style="white-space: nowrap;">
                                        Adicionar
                                    </button>
                                </div>
                            </div>

                            <!-- Qtd Vagas SVG -->
                            <div class="col-md-4">
                                <label asp-for="QtdVagasVoluntarios" class="form-label mb-1">Vagas Totais SVG</label>
                                <input asp-for="QtdVagasVoluntarios"
                                       name="QtdVagasVoluntarios"
                                       type="number" min="0"
                                       class="form-control form-control-sm" />
                                <span asp-validation-for="QtdVagasVoluntarios" class="text-danger"></span>

                                <!-- SVG Aberto -->
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           asp-for="SvgAberto"
                                           id="SvgAbertoToggle" />
                                    <label class="form-check-label" for="SvgAbertoToggle">
                                        SVG Aberto
                                    </label>
                                </div>
                            </div>
                        </div>

                        <hr class="my-3" />

                        <div class="mb-2 d-flex align-items-center flex-wrap gap-2">
                            <strong>Operadores selecionados (ordinários + voluntários):</strong>
                            <span id="contadorOperadores" class="badge bg-primary">0</span>

                            <span class="ms-0 ms-md-3 d-flex align-items-center gap-2">
                                <strong>SVG:</strong>
                                <span id="contadorOperadoresSvg" class="badge bg-success">0</span>
                            </span>
                        </div>

                        <ul id="listaOperadoresSelecionados" class="list-group">
                            <!-- JS adiciona itens aqui -->
                        </ul>

                    </div>
                </div>
            </div>



            <div class="modal fade" id="modalReforco" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h5 class="modal-title">Operação de S.O/Delta</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                        </div>

                        <div class="modal-body">
                            Você selecionou <strong>Segurança Orgânica ou Delta</strong>.
                            <br />
                            Deseja criar esta operação na tela específica de S.O / Delta?
                        </div>

                        <div class="modal-footer">
                          @*   <button type="button" class="btn btn-outline-secondary" id="btnNaoReforco" data-bs-dismiss="modal">
                                Não
                            </button> *@
                            <a class="btn btn-primary" id="btnSimReforco"
                               href="@Url.Action("CreateReforcoPlantao", "Operacao")">
                                Sim
                            </a>
                        </div>

                    </div>
                </div>
            </div>

        </div>

      

        <div class="d-flex justify-content-between mt-4">
            <a asp-action="Index" class="btn btn-outline-secondary">Voltar</a>
            @* <button type="submit" class="btn btn-success">Salvar Operação</button> *@
            <button type="submit" id="btnSalvar" class="btn btn-primary" disabled>Salvar</button>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>

         document.addEventListener("DOMContentLoaded", function () {
          const form = document.querySelector("form");
          const btnSalvar = document.getElementById("btnSalvar");

          // 1) Recria as regras unobtrusive
          $.validator.unobtrusive.parse(form);

          // 2) Pega o validator do form
          const validator = $(form).data("validator");
          console.log("Validator:", validator);

          function atualizarBotao() {
            const valido = $(form).valid();

            // DEBUG: quais campos estão errando
            if (!valido) {
              const v = $(form).validate();
              console.log("Campos com erro:", v.errorMap);
              console.log("Lista de erros:", v.errorList);
            }

            btnSalvar.disabled = !valido;
          }

          // Para aparecer erro quando o usuário mexer
          form.addEventListener("input", atualizarBotao);
          form.addEventListener("change", atualizarBotao);

          // Força mostrar mensagens ao tentar enviar
          form.addEventListener("submit", function (e) {
            if (!$(form).valid()) {
              e.preventDefault();
              $(form).validate().focusInvalid();
            }
          });

          // inicial
          atualizarBotao();
        });



        // Dados de operadores vindos do controller (ID, Nome, Matricula, SessaoID)
        const operadoresData = @Html.Raw(operadoresJson);

        // --- Coordenador: filtro inteligente em memória (busca + seleção automática)
        // (isolado e seguro: se algum elemento não existir, NÃO quebra os outros scripts)
        document.addEventListener("DOMContentLoaded", function () {
        const coordSearch = document.getElementById('coordenadorSearch');
        if (!coordSearch) return;

        coordSearch.addEventListener('input', function () {
            const coordSelect = document.getElementById('coordenadorSelect');
            if (!coordSelect) return;

            const termo = this.value.trim().toLowerCase();

            let firstMatchIndex = -1;
            let matchCount = 0;

            for (let i = 0; i < coordSelect.options.length; i++) {
                const opt = coordSelect.options[i];

                if (!opt.value) {
                    opt.hidden = false;
                    continue;
                }

                const texto = (opt.text || "").toLowerCase();
                const match = termo === "" || texto.includes(termo);

                opt.hidden = !match;

                if (match) {
                    matchCount++;
                    if (firstMatchIndex === -1) firstMatchIndex = i;
                }
            }

            if (termo === "") {
                coordSelect.selectedIndex = 0;
                coordSelect.size = 1;
                return;
            }

            if (matchCount === 1 && firstMatchIndex !== -1) {
                coordSelect.selectedIndex = firstMatchIndex;
                coordSelect.size = 1;
            } else if (matchCount > 1) {
                coordSelect.selectedIndex = firstMatchIndex;
                coordSelect.size = Math.min(matchCount + 1, 8);
            } else {
                coordSelect.selectedIndex = 0;
                coordSelect.size = 1;
            }
        });

        coordSearch.addEventListener('blur', function () {
            const coordSelect = document.getElementById('coordenadorSelect');
            if (coordSelect) coordSelect.size = 1;
        });
    });
// --- Preencher combo de voluntários com todos operadores
        const opSelect = document.getElementById('operadorSelect');
        function preencherComboVoluntarios() {
            operadoresData.forEach(op => {
                const opt = document.createElement('option');
                opt.value = op.ID;
                opt.text = `${op.Nome} (${op.Matricula})`;
                opSelect.appendChild(opt);
            });
        }
        preencherComboVoluntarios();

        const listaSessao = document.getElementById('listaOperadoresSessao');
        const listaSelecionados = document.getElementById('listaOperadoresSelecionados');
        const contadorOperadores = document.getElementById('contadorOperadores');
        const contadorOperadoresSvg = document.getElementById('contadorOperadoresSvg');

        function atualizarContadorOperadores() {
            // total
            const total = listaSelecionados.children.length;
            contadorOperadores.textContent = total;

            // somente os marcados como SVG (hidden input .inputSvgFlag == "true")
            const svgCount = listaSelecionados.querySelectorAll('.inputSvgFlag[value="true"]').length;
            contadorOperadoresSvg.textContent = svgCount;
        }


        // índice para OperadoresSelecionados[i]
        // let operadorIndex = 0;

       function renumerarSelecionados() {
            const itens = Array.from(listaSelecionados.children);
            const total = itens.length;

            itens.forEach((li, idx) => {
                // numeração invertida (topo = maior número)
                const badgeNum = li.querySelector('.badgeNumero');
                if (badgeNum) badgeNum.textContent = (total - idx);

                // renomeia inputs para ficar sequencial no POST
                const inputId = li.querySelector('.inputOperadorId');
                const inputSvg = li.querySelector('.inputSvgFlag');

                if (inputId) inputId.name = `OperadoresSelecionados[${idx}].OperadorID`;
                if (inputSvg) inputSvg.name = `OperadoresSelecionados[${idx}].SVG`;
            });

            atualizarContadorOperadores();
        }



        // Função comum para adicionar operador na lista final (seção ou voluntário)
                // Função comum para adicionar operador na lista final (seção ou voluntário)
        function adicionarOperador(op, svgFlag) {
            const liId = 'op-' + op.ID;
            if (document.getElementById(liId)) return;

            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.id = liId;

            const tipo = svgFlag ? 'Voluntário' : 'Ordinário';
            const svgText = svgFlag ? 'SVG: Sim' : 'SVG: Não';
            const svgBtnClass = svgFlag ? 'btn-outline-success' : 'btn-outline-secondary';

            li.innerHTML = `
                <div>
                    <span class="badge bg-secondary me-2 badgeNumero">1</span>
                    <strong>${op.Nome}</strong> (${op.Matricula})
                    <span class="badge bg-secondary ms-2 badgeTipo">${tipo}</span>
                </div>

                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn ${svgBtnClass} btnToggleSvg">${svgText}</button>
                    <button type="button" class="btn btn-outline-danger btnRemoverOperador">Remover</button>
                </div>

                <input type="hidden" value="${op.ID}" class="inputOperadorId" />
                <input type="hidden" value="${svgFlag}" class="inputSvgFlag" />
            `;

            // Remover
            li.querySelector('.btnRemoverOperador').addEventListener('click', function () {
                li.remove();
                renumerarSelecionados();
            });

            // Toggle SVG
            li.querySelector('.btnToggleSvg').addEventListener('click', function () {
                const inputSvg = li.querySelector('.inputSvgFlag');
                const atual = (inputSvg.value === "true");
                const novo = !atual;

                inputSvg.value = novo ? "true" : "false";

                // texto + cor do botão SVG
                this.textContent = novo ? "SVG: Sim" : "SVG: Não";
                this.classList.toggle("btn-outline-success", novo);
                this.classList.toggle("btn-outline-secondary", !novo);

                // >>> troca Ordinário/Voluntário junto com o SVG
                const badgeTipo = li.querySelector('.badgeTipo');
                if (badgeTipo) {
                    badgeTipo.textContent = novo ? "Voluntário" : "Ordinário";
                }

                atualizarContadorOperadores();
            });

            listaSelecionados.prepend(li);
            renumerarSelecionados();

            // destaque temporário (flash) no item recém adicionado
            li.classList.remove('op-added'); // garante re-trigger
            void li.offsetWidth;             // força reflow para reiniciar animação
            li.classList.add('op-added');

        }

        // --- Seção: ao selecionar no combo, apenas MOSTRA à esquerda.
        // --- Botão "Carregar seção": apenas ADICIONA à direita (SVG = false).
        const sessaoSelect = document.getElementById('sessaoSelect');
        const btnAddSessao = document.getElementById('btnAddSessao');

        function renderOperadoresDaSessao(sessaoId) {
            listaSessao.innerHTML = '';
            if (!sessaoId) return;

            const ops = operadoresData
                .filter(o => o.SessaoID === sessaoId)
                .sort((a, b) => (a.Nome || '').localeCompare(b.Nome || ''));

            ops.forEach(op => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = `${op.Nome} (${op.Matricula})`;
                listaSessao.appendChild(li);
            });
        }

        // 1) Mudou seção -> atualiza visualização à esquerda automaticamente
        sessaoSelect.addEventListener('change', function () {
            const sessaoId = parseInt(this.value);
            renderOperadoresDaSessao(sessaoId);
        });

        // 2) Botão -> adiciona todos da seção na lista da direita (como Ordinário / SVG: Não)
        btnAddSessao.addEventListener('click', function () {
            const sessaoId = parseInt(sessaoSelect.value);
            if (!sessaoId) return;

            const ops = operadoresData.filter(o => o.SessaoID === sessaoId);
            ops.forEach(op => adicionarOperador(op, false));
        });

        renderOperadoresDaSessao(parseInt(sessaoSelect.value));

        // --- Voluntários: filtro inteligente + adicionar individual (SVG = true)
        const opSearch = document.getElementById('operadorSearch');

        opSearch.addEventListener('input', function () {
            const termo = this.value.trim().toLowerCase();

            let firstMatchIndex = -1;
            let matchCount = 0;

            for (let i = 0; i < opSelect.options.length; i++) {
                const opt = opSelect.options[i];

                if (!opt.value) {
                    opt.hidden = false;
                    continue;
                }

                const texto = opt.text.toLowerCase();
                const match = termo === "" || texto.includes(termo);

                opt.hidden = !match;

                if (match) {
                    matchCount++;
                    if (firstMatchIndex === -1) {
                        firstMatchIndex = i;
                    }
                }
            }

            if (termo === "") {
                opSelect.selectedIndex = 0;
                opSelect.size = 1;
                return;
            }

            if (matchCount === 1 && firstMatchIndex !== -1) {
                opSelect.selectedIndex = firstMatchIndex;
                opSelect.size = 1;
            } else if (matchCount > 1) {
                opSelect.selectedIndex = firstMatchIndex;
                opSelect.size = Math.min(matchCount + 1, 8);
            } else {
                opSelect.selectedIndex = 0;
                opSelect.size = 1;
            }
        });

        opSearch.addEventListener('blur', function () {
            opSelect.size = 1;
        });

        const btnAddOperador = document.getElementById('btnAddOperador');
        btnAddOperador.addEventListener('click', function () {
            const opt = opSelect.options[opSelect.selectedIndex];
            if (!opt || !opt.value) return;

            const id = parseInt(opt.value);
            const op = operadoresData.find(o => o.ID === id);
            if (op) {
                adicionarOperador(op, true); // voluntário
            }
        });

        // --- Ao selecionar Coordenador, adicionar automaticamente na lista de operadores (direita)
        document.addEventListener("DOMContentLoaded", function () {
            const coordenadorSelect = document.getElementById('coordenadorSelect');
            if (!coordenadorSelect) return;

            coordenadorSelect.addEventListener('change', function () {
                const coordId = parseInt(this.value);
                if (!coordId) return;

                const op = operadoresData.find(o => o.ID === coordId);
                if (op) {
                    // Coordenador participa da operação => entra como Ordinário (SVG: Não)
                    adicionarOperador(op, false);
                }
            });
        });

        (function () {
            const TIPO_REFORCO_PLANTAO_ID = "4"; // ID 4 = Reforço Plantão
            const TIPO_DELTA_ID = "3"; // ID 3 = Reforço Plantão

            const selectTipo = document.getElementById("TipoOperacaoID");
            const modalEl = document.getElementById("modalReforco");
            const btnNao = document.getElementById("btnNaoReforco");

            if (!selectTipo || !modalEl) return;

            const modal = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false });

            let valorAnterior = selectTipo.value || "";

            // guarda valor anterior ao mudar (para poder voltar se clicar "Não")
            selectTipo.addEventListener("focus", function () {
                valorAnterior = selectTipo.value || "";
            });

            selectTipo.addEventListener("change", function () {
                const valorAtual = selectTipo.value || "";

                        if (valorAtual === TIPO_REFORCO_PLANTAO_ID || valorAtual === TIPO_DELTA_ID) {
                    modal.show();
                }
            });

            // Se clicar "Não", volta para o valor anterior (ou limpa)
            if (btnNao) {
                btnNao.addEventListener("click", function () {
                    selectTipo.value = valorAnterior || "";
                });
            }

            // Se fechar no X (ou por qualquer motivo), também volta
            modalEl.addEventListener("hidden.bs.modal", function () {
                // se o usuário não clicou em "Sim", volta (a navegação do "Sim" troca de página)
                if (selectTipo.value === TIPO_REFORCO_PLANTAO_ID || valorAtual === TIPO_DELTA_ID) {
                    selectTipo.value = valorAnterior || "";
                }
            });
        })();
    </script>
}

<style>
    .op-added {
        animation: opAddedGlow 1.5s ease-out;
    }

    @@keyframes opAddedGlow {
        0%

    {
        box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.55);
        border-left: 4px solid rgba(25,135,84,0.9);
    }

    100% {
        box-shadow: 0 0 0 10px rgba(25, 135, 84, 0);
        border-left: 4px solid transparent;
    }

    }
</style>