@model SVG.App.ViewModels.OperacaoViewModel

@using SVG.Domain.Entities

@{
    ViewData["Title"] = "Nova Operação";

    // Default no Create: SvgAberto = true (sem sobrescrever quando volta com ModelState inválido)
    if (!ViewContext.ViewData.ModelState.ContainsKey(nameof(Model.SvgAberto)))
    {
        Model.SvgAberto = true;
    }

    var coordenadores = (IEnumerable<Operador>)ViewBag.Coordenadores;
    var operadoresJson = (string)ViewBag.OperadoresJson;
    var sessoes = (IEnumerable<Sessao>)ViewBag.Sessoes;
    var tipos = (IEnumerable<TipoOperacao>)ViewBag.TiposOperacao;
}

<div class="container mt-4">
    <h2>Nova Operação</h2>
    <hr />

    <form asp-action="Create" method="post" class="mt-3">

        <div class="row g-3 align-items-end">
            <!-- Data / Hora -->
            <div class="col-md-2">
                <label asp-for="DataHora" class="form-label">Data / Hora</label>
                <input asp-for="DataHora" name="DataHora" class="form-control" />
                <span asp-validation-for="DataHora" class="text-danger"></span>
            </div>

            <!-- Objeto (reduzido) -->
            <div class="col-md-2">
                <label asp-for="Objeto" class="form-label">Local</label>
                <input asp-for="Objeto" name="Objeto" class="form-control" />
                <span asp-validation-for="Objeto" class="text-danger"></span>
            </div>

            <!-- DP Apoio (reduzido) -->
            <div class="col-md-1">
                <label asp-for="OrdemServico" class="form-label">Ordem Serviço</label>
                <input asp-for="OrdemServico" name="OrdemServico" class="form-control" />
                <span asp-validation-for="DP" class="text-danger"></span>
            </div>

            <!-- Coordenador (combo com busca em memória) -->
            <div class="col-md-3">
                <label class="form-label">Coordenador</label>
                <input type="text" id="coordenadorSearch" class="form-control mb-2"
                       placeholder="Buscar coordenador..." />
                <select asp-for="CoordenadorOperadorID"
                        name="CoordenadorOperadorID"
                        class="form-select"
                        id="coordenadorSelect">
                    <option value="">Selecione...</option>
                    @if (coordenadores != null)
                    {
                        foreach (var c in coordenadores.OrderBy(x => x.Nome))
                        {
                            <option value="@c.ID">@c.Nome</option>
                        }
                    }
                </select>
                <span asp-validation-for="CoordenadorOperadorID" class="text-danger"></span>
            </div>

            <!-- Tipo -->
            <div class="col-md-3">
                <label class="form-label">Tipo</label>
                <select asp-for="TipoOperacaoID"
                        name="TipoOperacaoID"
                        class="form-select">
                    <option value="">...</option>
                    @if (tipos != null)
                    {
                        foreach (var t in tipos.OrderBy(x => x.Nome))
                        {
                            <option value="@t.ID">@t.Nome</option>
                        }
                    }
                </select>
                <span asp-validation-for="TipoOperacaoID" class="text-danger"></span>
            </div>
        </div>

        <div class="row mt-4 g-4">
            <!-- Operadores por Sessão -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Operadores por Sessão
                    </div>
                    <div class="card-body">

                        <div class="row g-2 align-items-end">
                            <div class="col-md-7">
                                <label class="form-label">Selecionar Sessão</label>
                                <select class="form-select" id="sessaoSelect">
                                    <option value="">Escolha a sessão...</option>
                                    @if (sessoes != null)
                                    {
                                        foreach (var s in sessoes.OrderBy(x => x.Nome))
                                        {
                                            <option value="@s.ID">@s.Nome</option>
                                        }
                                    }
                                </select>
                            </div>

                            <div class="col-md-5 d-grid">
                                <button type="button" id="btnCarregarSessao" class="btn btn-primary">
                                    Carregar sessão
                                </button>
                            </div>
                        </div>

                        <hr />

                        <h6><strong>Operadores da sessão selecionada:</strong></h6>
                        <ul id="listaOperadoresSessao" class="list-group"></ul>
                    </div>
                </div>
            </div>

            <!-- Operadores voluntários -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Operadores voluntários
                    </div>
                    <!-- SVG Aberto -->
                    <div class="mt-3">
                        <label class="form-label mb-1">SVG Aberto</label>

                        <!-- valor enviado no POST -->
                        <input asp-for="SvgAberto" type="hidden" id="SvgAberto" name="SvgAberto" />

                        <div class="btn-group w-100" role="group" aria-label="SVG Aberto">
                            <button type="button" id="btnSvgAbertoOn" class="btn btn-success">Sim</button>
                            <button type="button" id="btnSvgAbertoOff" class="btn btn-outline-secondary">Não</button>
                        </div>
                    </div>

                    <div class="card-body">

                        <div class="row g-2 align-items-end">
                            <div class="col-md-8">
                                <label class="form-label">Buscar Operador</label>
                                <input type="text" id="operadorSearch" class="form-control"
                                       placeholder="Digite o nome para filtrar..." />
                            </div>

                            <!-- Qtd Vagas SVG -->
                            <div class="col-md-4">
                                <label asp-for="QtdVagasVoluntarios" class="form-label">Qtd Vagas SVG</label>
                                <input asp-for="QtdVagasVoluntarios"
                                       name="QtdVagasVoluntarios"
                                       type="number" min="0"
                                       class="form-control" />
                                <span asp-validation-for="QtdVagasVoluntarios" class="text-danger"></span>


                            </div>
                        </div>

                        <div class="mb-2 d-flex align-items-center">
                            <strong>Operadores selecionados (sessão + voluntários):</strong>
                            <span id="contadorOperadores" class="badge bg-primary ms-2">0</span>
                        </div>
                        <ul id="listaOperadoresSelecionados" class="list-group"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between mt-4">
            <a asp-action="Index" class="btn btn-outline-secondary">Voltar</a>
            <button type="submit" class="btn btn-success">Salvar Operação</button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        // -----------------------------
        // Dados dos operadores (JSON)
        // -----------------------------
        const operadoresData = @Html.Raw(operadoresJson ?? "[]");

        // -----------------------------
        // Coordenador (busca em memória)
        // -----------------------------
        const coordenadorSearch = document.getElementById('coordenadorSearch');
        const coordenadorSelect = document.getElementById('coordenadorSelect');

        coordenadorSearch.addEventListener('input', function () {
            const termo = this.value.trim().toLowerCase();
            const options = coordenadorSelect.options;

            for (let i = 0; i < options.length; i++) {
                const txt = options[i].text.toLowerCase();
                options[i].hidden = termo && !txt.includes(termo);
            }
        });

        // -----------------------------
        // Helper: atualizar contador
        // -----------------------------
        function atualizarContador() {
            const lista = document.getElementById('listaOperadoresSelecionados');
            const total = lista.querySelectorAll('li').length;
            document.getElementById('contadorOperadores').innerText = total;
        }

        // -----------------------------
        // Helper: adicionar operador na lista final
        // SVG = true apenas para voluntários
        // -----------------------------
        let indexOperadores = 0;

        function adicionarOperador(op, isVoluntarioSvg) {
            const lista = document.getElementById('listaOperadoresSelecionados');

            // evita duplicados
            if (lista.querySelector(`[data-op-id="${op.ID}"]`)) return;

            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.setAttribute('data-op-id', op.ID);

            li.innerHTML = `
                <div>
                    <strong>${op.Nome}</strong>
                    <div class="small text-muted">${op.Matricula ?? ""} - Sessão ${op.SessaoID}</div>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger">Remover</button>

                <input type="hidden" name="OperadoresSelecionados[${indexOperadores}].OperadorID" value="${op.ID}" />
                <input type="hidden" name="OperadoresSelecionados[${indexOperadores}].SVG" value="${isVoluntarioSvg ? 'true' : 'false'}" />
            `;

            li.querySelector('button').addEventListener('click', function () {
                li.remove();
                atualizarContador();
            });

            lista.appendChild(li);
            indexOperadores++;
            atualizarContador();
        }

        // -----------------------------
        // Sessão: carregar operadores
        // -----------------------------
        const btnCarregarSessao = document.getElementById('btnCarregarSessao');
        btnCarregarSessao.addEventListener('click', function () {
            const sessaoId = parseInt(document.getElementById('sessaoSelect').value);
            const listaSessao = document.getElementById('listaOperadoresSessao');
            listaSessao.innerHTML = '';

            if (!sessaoId) return;

            const ops = operadoresData.filter(o => o.SessaoID === sessaoId);

            ops.forEach(op => {
                const li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = `${op.Nome} (${op.Matricula})`;
                listaSessao.appendChild(li);
            });

            // adiciona na lista final (sessão)
            ops.forEach(op => adicionarOperador(op, false));
        });

        // -----------------------------
        // Voluntários: filtro inteligente
        // -----------------------------
        const opSearch = document.getElementById('operadorSearch');
        const opSelect = document.getElementById('operadorSelect');

        function carregarSelectFiltrado(termo) {
            opSelect.innerHTML = '<option value="">Selecione um operador...</option>';

            const filtrados = operadoresData
                .filter(o => !termo || (o.Nome || '').toLowerCase().includes(termo))
                .slice(0, 50);

            filtrados.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.ID;
                opt.textContent = `${o.Nome} (${o.Matricula ?? ""})`;
                opSelect.appendChild(opt);
            });
        }

        carregarSelectFiltrado('');

        opSearch.addEventListener('input', function () {
            const termo = this.value.trim().toLowerCase();
            carregarSelectFiltrado(termo);
        });

        const btnAddOperador = document.getElementById('btnAddOperador');
        btnAddOperador.addEventListener('click', function () {
            const opt = opSelect.options[opSelect.selectedIndex];
            if (!opt || !opt.value) return;

            const id = parseInt(opt.value);
            const op = operadoresData.find(o => o.ID === id);
            if (op) {
                adicionarOperador(op, true); // voluntário
            }
        });

        // -------------------------------
        // SVG Aberto - toggle ligar/desligar
        // -------------------------------
              document.addEventListener("DOMContentLoaded", function () {
          const svgAbertoInput = document.getElementById("SvgAberto");
          const btnOn = document.getElementById("btnSvgAbertoOn");
          const btnOff = document.getElementById("btnSvgAbertoOff");

          if (!svgAbertoInput || !btnOn || !btnOff) return;

          function aplicar(isAberto) {
            svgAbertoInput.value = isAberto ? "true" : "false";
            btnOn.className = isAberto ? "btn btn-success" : "btn btn-outline-secondary";
            btnOff.className = isAberto ? "btn btn-outline-secondary" : "btn btn-danger";
          }

          // normalize: pode vir "True"/"False"
          const inicial = (String(svgAbertoInput.value).toLowerCase() === "true");
          aplicar(inicial);

          btnOn.addEventListener("click", function (e) { e.preventDefault(); aplicar(true); });
          btnOff.addEventListener("click", function (e) { e.preventDefault(); aplicar(false); });
        });

    </script>
}
