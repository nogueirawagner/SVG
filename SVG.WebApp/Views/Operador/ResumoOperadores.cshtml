@using SVG.Domain.TiposEstruturados.TiposOperador
@model IEnumerable<XResumoOperadorOperacao>

@{
    ViewData["Title"] = "Resumo de Operações por Operador";
}

<div class="container mt-4">
    <h2>Resumo de Operações por Operador</h2>
    <hr />

    <!-- Barra de busca -->
    <div class="row mb-3">
        <div class="col-md-6">
            <label for="buscarNome" class="form-label">Buscar por nome</label>
            <input type="text"
                   id="buscarNome"
                   class="form-control"
                   placeholder="Digite parte do nome do operador..." />
        </div>

        <div class="col-md-6">
            <label for="buscarSessao" class="form-label">Buscar por seção</label>
            <input type="text"
                   id="buscarSessao"
                   class="form-control"
                   placeholder="Digite parte do nome da seção..." />
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover" id="tabelaResumo">
            <thead class="table-light">
                <tr>
                    <th style="width: 90px;">Ações</th>

                    <th>
                        Nome
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary ms-1"
                                onclick="ordenarTabela(1, false)">
                            ⇅
                        </button>
                    </th>
                    <th>Matrícula</th>
                    <th>Telefone</th>
                    <th>Seção</th>

                    <th class="text-end">
                        Qtd Operações
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary ms-1"
                                onclick="ordenarTabela(5, true)">
                            ⇅
                        </button>
                    </th>

                    <th class="text-end">
                        Qtd Operações SVG
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary ms-1"
                                onclick="ordenarTabela(6, true)">
                            ⇅
                        </button>
                    </th>

                    <th class="text-end">
                        Média Ponderada
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary ms-1"
                                onclick="ordenarTabela(7, true)">
                            ⇅
                        </button>
                    </th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr data-operador-id="@item.OperadorID">
                        <td>
                            <button type="button"
                                    class="btn btn-sm btn-primary"
                                    onclick="toggleDetalhes(this)"
                                    data-loaded="false"
                                    data-expanded="false">
                                Detalhes
                            </button>
                        </td>
                        <td>@item.OperadorNome</td>
                        <td>@item.Matricula</td>
                        <td>@item.Telefone</td>
                        <td>@item.Sessao</td>
                        <td class="text-end">@item.QtdOperacoes</td>
                        <td class="text-end">@item.QtdOperacoesSVG</td>
                        <td class="text-end">@item.MediaPonderada.ToString("N2")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        // --- FILTROS (Nome + Seção) ---
        const inputBuscaNome = document.getElementById('buscarNome');
        const inputBuscaSessao = document.getElementById('buscarSessao');
        const tabela = document.getElementById('tabelaResumo');
        const tbody = tabela.querySelector('tbody');

        function aplicarFiltros() {
            const termoNome = inputBuscaNome.value.trim().toLowerCase();
            const termoSessao = inputBuscaSessao.value.trim().toLowerCase();

            for (let i = 0; i < tbody.rows.length; i++) {
                const row = tbody.rows[i];

                const nomeCell = row.cells[1];   // coluna Nome
                const sessaoCell = row.cells[4]; // coluna Seção

                const nome = nomeCell.textContent.toLowerCase();
                const sessao = sessaoCell.textContent.toLowerCase();

                const matchNome = termoNome === "" || nome.includes(termoNome);
                const matchSessao = termoSessao === "" || sessao.includes(termoSessao);

                // Exibe só se passar nos dois filtros
                if (matchNome && matchSessao) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }

        inputBuscaNome.addEventListener('input', aplicarFiltros);
        inputBuscaSessao.addEventListener('input', aplicarFiltros);

        // --- ORDENAÇÃO ---
        let estadoOrdenacao = {
            coluna: null,
            asc: true
        };

        // colIndex: índice da coluna (0-based)
        // isNumeric: true para números, false para texto
        function ordenarTabela(colIndex, isNumeric) {
            const rowsArray = Array.from(tbody.querySelectorAll('tr'));
            const mesmaColuna = estadoOrdenacao.coluna === colIndex;

            // Se clicar na mesma coluna, inverte a direção
            if (mesmaColuna) {
                estadoOrdenacao.asc = !estadoOrdenacao.asc;
            } else {
                estadoOrdenacao.coluna = colIndex;
                estadoOrdenacao.asc = true; // começa crescente
            }

            rowsArray.sort((a, b) => {
                const aText = a.cells[colIndex].textContent.trim();
                const bText = b.cells[colIndex].textContent.trim();

                let comp = 0;

                if (isNumeric) {
                    const aVal = parseFloat(aText.replace(',', '.')) || 0;
                    const bVal = parseFloat(bText.replace(',', '.')) || 0;
                    comp = aVal - bVal;
                } else {
                    comp = aText.localeCompare(bText, 'pt-BR');
                }

                return estadoOrdenacao.asc ? comp : -comp;
            });

            // Reanexa as linhas na nova ordem
            rowsArray.forEach(row => tbody.appendChild(row));
        }

        const urlDetalhesOperador = '@Url.Action("DetalhesOperador", "Operador")';

        async function toggleDetalhes(button) {
            const tr = button.closest('tr');
            const operadorId = tr.getAttribute('data-operador-id');

            const expanded = button.getAttribute('data-expanded') === 'true';

            // Se já expandido → retrai
            if (expanded) {
                const nextRow = tr.nextElementSibling;
                if (nextRow && nextRow.classList.contains('detalhes-operador-row')) {
                    nextRow.remove();
                }
                button.setAttribute('data-expanded', 'false');
                button.textContent = "Detalhes";
                return;
            }

            // Não expandido ainda → buscar detalhamento via AJAX
            button.disabled = true;
            button.textContent = "Carregando...";

            try {
                const response = await fetch(`${urlDetalhesOperador}?pOperadorId=${operadorId}`);
                if (!response.ok) throw new Error("Erro ao carregar detalhes");

                const html = await response.text();

                // Cria nova linha abaixo
                const detalhesRow = document.createElement('tr');
                detalhesRow.classList.add('detalhes-operador-row');

                const colCount = tr.cells.length;

                detalhesRow.innerHTML = `
                    <td colspan="${colCount}">
                        <div class="mt-2">
                            ${html}
                        </div>
                    </td>
                `;

                tr.parentNode.insertBefore(detalhesRow, tr.nextSibling);

                button.setAttribute('data-expanded', 'true');
                button.textContent = "Recolher";

            } catch (e) {
                console.error(e);
                alert("Erro ao carregar detalhamento.");
                button.textContent = "Detalhes";
            } finally {
                button.disabled = false;
            }
        }
    </script>
}
